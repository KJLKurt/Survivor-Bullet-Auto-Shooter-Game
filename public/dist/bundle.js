var Se=.016666666666666666,Ce=.05,I={PROFILE:"survivor.profile.v1",SETTINGS:"survivor.settings.v1",HINT_SEEN:"survivor.hintSeen.v1"},h={WIDTH:960,HEIGHT:540,PLAYER_SPAWN_X:480,PLAYER_SPAWN_Y:300},x={PLAYER:"#53cdf8",PLAYER_CORE:"#ffd089",AIM:"#9fe8ff",PLAYER_PROJECTILE:"#ffe1a8",ENEMY_PROJECTILE:"#ff7070",ENEMY:"#ff8b7b",ENEMY_FLASH:"#fff2aa",COIN:"#f6d15e",COIN_STROKE:"#9f7e1a",HUD_TEXT:"#d7f3ff"},K={MAX_ENEMIES:64,MAX_PROJECTILES:420,MAX_COINS:180},g={PLAYER:16,ENEMY_SMALL:18,ENEMY_MEDIUM:24,ENEMY_LARGE:30,PROJECTILE:6,ENEMY_PROJECTILE:7,COIN:5},S={PLAYER_INVULN_MS_ON_HIT:220,COIN_LIFETIME_SECONDS:10,COIN_PICKUP_BASE_RADIUS:36,COIN_MAGNET_PER_LEVEL:11,ENEMY_FLASH_SECONDS:.08,SHOOT_FALLBACK_Y:-1},ct=[{id:"pulse",name:"Pulse Blaster",cooldownMs:280,projectileSpeed:440,damage:11,spreadDegrees:2,projectilesPerShot:1,special:"none"},{id:"twin",name:"Twin Fork",cooldownMs:340,projectileSpeed:420,damage:8,spreadDegrees:12,projectilesPerShot:2,special:"piercing"},{id:"nova",name:"Nova Scatter",cooldownMs:560,projectileSpeed:390,damage:7,spreadDegrees:28,projectilesPerShot:5,special:"explosive"},{id:"rail",name:"Rail Needle",cooldownMs:520,projectileSpeed:560,damage:22,spreadDegrees:0,projectilesPerShot:1,special:"piercing"}],C=Object.fromEntries(ct.map(e=>[e.id,e])),ee={bankCoins:0,totalCoinsCollected:0,playCount:0,highScore:0,levelsCompleted:[],perLevelBest:{},ownedLevels:{},selectedCharacterId:"runner",selectedWeaponId:"pulse",unlockedCharacters:["runner"],unlockedWeapons:["pulse"]},te={sfxEnabled:!0};function dt(){return window.AudioContext||window.webkitAudioContext}var ne=class{constructor(){this.registry=new Map,this.enabled=!0,this.audioContext=null,this.unlocked=!1,this.unlockHandler=null}setEnabled(t){this.enabled=!!t}getContext(){if(!this.audioContext){let t=dt();if(!t)return null;this.audioContext=new t}return this.audioContext}enableAutoUnlock(){if(!this.unlockHandler){this.unlockHandler=async()=>{this.unlocked=!0;let t=this.getContext();t?.state==="suspended"&&await t.resume().catch(()=>{});for(let n of["pointerdown","keydown","touchstart"])window.removeEventListener(n,this.unlockHandler)};for(let t of["pointerdown","keydown","touchstart"])window.addEventListener(t,this.unlockHandler,{once:!0,passive:!0})}}register(t,n){this.registry.set(t,n)}play(t,n={}){if(!this.enabled||!this.unlocked)return;let o=this.registry.get(t);if(!o)return;let s=this.getContext();if(s){if(o instanceof AudioBuffer){let i=s.createBufferSource();i.buffer=o,i.connect(s.destination),i.start();return}typeof o=="function"&&o(s,n)}}};function M(e,{frequency:t=440,duration:n=.08,type:o="square",volume:s=.03,slide:i=0}){let l=e.createOscillator(),u=e.createGain();l.type=o,l.frequency.value=t,i&&l.frequency.linearRampToValueAtTime(t+i,e.currentTime+n),u.gain.setValueAtTime(s,e.currentTime),u.gain.exponentialRampToValueAtTime(1e-4,e.currentTime+n),l.connect(u),u.connect(e.destination),l.start(),l.stop(e.currentTime+n)}function Me(){let e=new ne;return e.enableAutoUnlock(),e.register("shoot",t=>M(t,{frequency:760,duration:.05,type:"square",volume:.02,slide:-160})),e.register("hit",t=>M(t,{frequency:280,duration:.06,type:"triangle",volume:.03,slide:-30})),e.register("enemyDeath",t=>M(t,{frequency:180,duration:.1,type:"sawtooth",volume:.04,slide:-120})),e.register("coin",t=>M(t,{frequency:960,duration:.04,type:"triangle",volume:.03,slide:120})),e.register("levelUp",t=>{M(t,{frequency:520,duration:.06,type:"triangle",volume:.03,slide:120}),M(t,{frequency:690,duration:.08,type:"triangle",volume:.03,slide:140})}),e.register("shopBuy",t=>M(t,{frequency:640,duration:.08,type:"square",volume:.03,slide:80})),e.register("updateAvailable",t=>M(t,{frequency:430,duration:.18,type:"sine",volume:.03,slide:80})),e}var $=[{id:"runner",name:"Runner",startingWeaponId:"pulse",stats:{maxHealth:110,healthRegen:2.8,speed:218,baseDamage:10,cooldownMs:290,size:15,armorPercent:.04},unlockCondition:{type:"default",value:0}},{id:"bulwark",name:"Bulwark",startingWeaponId:"pulse",stats:{maxHealth:170,healthRegen:2,speed:168,baseDamage:12,cooldownMs:320,size:18,armorPercent:.18},unlockCondition:{type:"coins",value:120}},{id:"spark",name:"Spark",startingWeaponId:"twin",stats:{maxHealth:95,healthRegen:2.4,speed:240,baseDamage:8,cooldownMs:220,size:14,armorPercent:.02},unlockCondition:{type:"playCount",value:3}},{id:"warden",name:"Warden",startingWeaponId:"rail",stats:{maxHealth:150,healthRegen:2.2,speed:182,baseDamage:15,cooldownMs:420,size:17,armorPercent:.12},unlockCondition:{type:"score",value:1400}},{id:"rift",name:"Rift",startingWeaponId:"nova",stats:{maxHealth:105,healthRegen:2.1,speed:205,baseDamage:13,cooldownMs:370,size:16,armorPercent:.06},unlockCondition:{type:"levelsCompleted",value:1}},{id:"echo",name:"Echo",startingWeaponId:"twin",stats:{maxHealth:120,healthRegen:3.2,speed:198,baseDamage:9,cooldownMs:250,size:15,armorPercent:.05},unlockCondition:{type:"coins",value:380}},{id:"viper",name:"Viper",startingWeaponId:"rail",stats:{maxHealth:100,healthRegen:1.9,speed:245,baseDamage:16,cooldownMs:470,size:14,armorPercent:.03},unlockCondition:{type:"score",value:2600}},{id:"atlas",name:"Atlas",startingWeaponId:"pulse",stats:{maxHealth:210,healthRegen:2.5,speed:158,baseDamage:14,cooldownMs:340,size:20,armorPercent:.2},unlockCondition:{type:"levelsCompleted",value:2}},{id:"aster",name:"Aster",startingWeaponId:"nova",stats:{maxHealth:112,healthRegen:2.6,speed:214,baseDamage:11,cooldownMs:300,size:15,armorPercent:.07},unlockCondition:{type:"playCount",value:9}},{id:"sol",name:"Sol",startingWeaponId:"rail",stats:{maxHealth:132,healthRegen:2.4,speed:190,baseDamage:18,cooldownMs:450,size:16,armorPercent:.1},unlockCondition:{type:"score",value:4200}}],oe=Object.fromEntries($.map(e=>[e.id,e]));var se=[{id:"vitality_core",name:"Vitality Core",kind:"upgrade",description:"Increase max health with diminishing gains.",maxLevel:5,costs:[20,45,80,130,190],effect:{stat:"maxHealth",mode:"add",perLevel:14}},{id:"regen_thread",name:"Regen Thread",kind:"upgrade",description:"Improve passive health regeneration.",maxLevel:4,costs:[25,55,95,150],effect:{stat:"healthRegen",mode:"add",perLevel:.42}},{id:"agility_shards",name:"Agility Shards",kind:"upgrade",description:"Boost movement speed.",maxLevel:5,costs:[30,65,110,170,245],effect:{stat:"speed",mode:"add",perLevel:10}},{id:"reinforced_plating",name:"Reinforced Plating",kind:"upgrade",description:"Increase armor percentage.",maxLevel:4,costs:[35,80,140,220],effect:{stat:"armorPercent",mode:"add",perLevel:.03}},{id:"focusing_lens",name:"Focusing Lens",kind:"upgrade",description:"Scale outgoing damage.",maxLevel:5,costs:[40,92,154,228,315],effect:{stat:"damageMultiplier",mode:"mult",perLevel:.1}},{id:"quick_chamber",name:"Quick Chamber",kind:"upgrade",description:"Raise fire rate with smaller late gains.",maxLevel:5,costs:[34,76,129,198,286],effect:{stat:"fireRateMultiplier",mode:"mult",perLevel:.08}},{id:"kinetic_booster",name:"Kinetic Booster",kind:"upgrade",description:"Increase projectile speed.",maxLevel:4,costs:[22,49,86,140],effect:{stat:"projectileSpeedMultiplier",mode:"mult",perLevel:.12}},{id:"coin_magnet",name:"Coin Magnet",kind:"upgrade",description:"Expand coin pickup radius.",maxLevel:5,costs:[16,36,60,90,126],effect:{stat:"pickupRadius",mode:"add",perLevel:11}},{id:"stability_mesh",name:"Stability Mesh",kind:"upgrade",description:"Reduce hitbox size slightly.",maxLevel:3,costs:[28,68,125],effect:{stat:"size",mode:"add",perLevel:-.9}},{id:"assault_matrix",name:"Assault Matrix",kind:"upgrade",description:"Add flat base damage.",maxLevel:4,costs:[33,72,121,185],effect:{stat:"baseDamage",mode:"add",perLevel:1.8}},{id:"coolant_loop",name:"Coolant Loop",kind:"upgrade",description:"Lower cooldown baseline.",maxLevel:4,costs:[29,63,108,166],effect:{stat:"cooldownMs",mode:"add",perLevel:-16}},{id:"surge_lattice",name:"Surge Lattice",kind:"upgrade",description:"Small all-round scaling for late game.",maxLevel:3,costs:[90,170,285],effect:{stat:"damageMultiplier",mode:"mult",perLevel:.06}}],ae=Object.fromEntries(se.map(e=>[e.id,e]));var L=[{id:"dockyard",name:"Storm Dockyard",backgroundColor:"#102034",durationSeconds:85,spawnIntervalSeconds:1.15,difficulty:1,waves:[{start:0,end:24,type:"skitter",pattern:"wave",spawnMultiplier:1},{start:24,end:50,type:"skitter",pattern:"aimed_burst",spawnMultiplier:.9},{start:50,end:85,type:"brute",pattern:"radial",spawnMultiplier:.8}]},{id:"citadel",name:"Fracture Citadel",backgroundColor:"#2b1b28",durationSeconds:95,spawnIntervalSeconds:1,difficulty:2,waves:[{start:0,end:30,type:"skitter",pattern:"spiral",spawnMultiplier:.95},{start:30,end:62,type:"brute",pattern:"aimed_burst",spawnMultiplier:.82},{start:62,end:95,type:"elite",pattern:"radial",spawnMultiplier:.78}]},{id:"riftcore",name:"Riftcore Gate",backgroundColor:"#182431",durationSeconds:110,spawnIntervalSeconds:.9,difficulty:3,waves:[{start:0,end:38,type:"brute",pattern:"spiral",spawnMultiplier:.88},{start:38,end:74,type:"elite",pattern:"wave",spawnMultiplier:.75},{start:74,end:110,type:"elite",pattern:"aimed_burst",spawnMultiplier:.68}]}],jt=Object.fromEntries(L.map(e=>[e.id,e]));var F=class{constructor({update:t,render:n,stepSeconds:o=Se,maxFrameSeconds:s=Ce,now:i=()=>performance.now()}){this.update=t,this.render=n,this.stepSeconds=o,this.maxFrameSeconds=s,this.now=i,this.accumulator=0,this.lastTimestamp=null,this.running=!1,this.rafId=null,this.boundFrame=this.frame.bind(this)}frame(t=this.now()){if(this.lastTimestamp===null)return this.lastTimestamp=t,this.render(0),{steps:0,alpha:0,frameTimeSeconds:0};let n=(t-this.lastTimestamp)/1e3;this.lastTimestamp=t,n>this.maxFrameSeconds&&(n=this.maxFrameSeconds),this.accumulator+=n;let o=0;for(;this.accumulator>=this.stepSeconds;)this.update(this.stepSeconds),this.accumulator-=this.stepSeconds,o+=1;let s=this.accumulator/this.stepSeconds;return this.render(s),{steps:o,alpha:s,frameTimeSeconds:n}}start(){if(this.running)return;this.running=!0,this.lastTimestamp=null;let t=n=>{this.running&&(this.frame(n),this.rafId=requestAnimationFrame(t))};this.rafId=requestAnimationFrame(t)}stop(){this.running=!1,this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null)}};function Le(e){return Math.hypot(e.x,e.y)}function p(e){let t=Le(e);return t?{x:e.x/t,y:e.y/t}:{x:0,y:0}}function ke(e,t){let n=Le(e);if(!n||n<=t)return{x:e.x,y:e.y};let o=t/n;return{x:e.x*o,y:e.y*o}}function T(e,t,n){return e+(t-e)*n}function P(e){return{x:Math.cos(e),y:Math.sin(e)}}var Ie={skitter:{size:g.ENEMY_SMALL,speed:64,maxHealth:18,damage:9,shotDamage:7,shotSpeed:190,shootCooldown:1.3},brute:{size:g.ENEMY_MEDIUM,speed:44,maxHealth:36,damage:14,shotDamage:11,shotSpeed:170,shootCooldown:1.9},elite:{size:g.ENEMY_LARGE,speed:58,maxHealth:58,damage:18,shotDamage:13,shotSpeed:220,shootCooldown:1.15}};function ut(e,t=h){let n=Math.floor(Math.random()*4);return n===0?{x:Math.random()*t.WIDTH,y:-e*2}:n===1?{x:t.WIDTH+e*2,y:Math.random()*t.HEIGHT}:n===2?{x:Math.random()*t.WIDTH,y:t.HEIGHT+e*2}:{x:-e*2,y:Math.random()*t.HEIGHT}}function Te(e,t,n,o=1,s=h){let i=Ie[t]??Ie.skitter,l=ut(i.size,s);return{id:e,type:t,pattern:n,x:l.x,y:l.y,prevX:l.x,prevY:l.y,size:i.size,speed:i.speed+o*4,maxHealth:i.maxHealth*(1+o*.08),health:i.maxHealth*(1+o*.08),contactDamage:i.damage,shotDamage:i.shotDamage,shotSpeed:i.shotSpeed,shootCooldown:Math.max(.32,i.shootCooldown-o*.04),shootTimer:0,spiralAngle:0,alive:!0,flashDuration:S.ENEMY_FLASH_SECONDS,flashTimer:0}}function Pe(e){e.prevX=e.x,e.prevY=e.y}function ht(e,t,n,o){let s=p({x:t.x-e.x,y:t.y-e.y});if(e.pattern==="wave"){let i=Math.sin(o*4+e.id*.9);e.x+=(s.x*e.speed+i*26)*n,e.y+=s.y*e.speed*.7*n;return}if(e.pattern==="spiral"){let i=P(Math.atan2(s.y,s.x)+Math.PI/2);e.x+=(s.x*e.speed*.7+i.x*34)*n,e.y+=(s.y*e.speed*.7+i.y*34)*n;return}e.x+=s.x*e.speed*n,e.y+=s.y*e.speed*n}function pt(e,t){for(let o=0;o<8;o+=1){let s=Math.PI*2*o/8,i=P(s);t(e,i)}}function mt(e,t){e.spiralAngle+=Math.PI/9;let n=P(e.spiralAngle);t(e,n)}function ft(e,t,n){let o=Math.atan2(t.y-e.y,t.x-e.x),s=[-.18,0,.18];for(let i of s)n(e,P(o+i))}function vt(e,t,n){let o=Math.sin(t*5+e.id)*.4;n(e,p({x:1,y:o})),n(e,p({x:-1,y:-o}))}function Ae(e,t,n,o,s){if(e.alive&&(e.flashTimer=Math.max(0,e.flashTimer-t),ht(e,n,t,o),e.shootTimer-=t,!(e.shootTimer>0))){if(e.shootTimer=e.shootCooldown,e.pattern==="radial"){pt(e,s);return}if(e.pattern==="spiral"){mt(e,s);return}if(e.pattern==="aimed_burst"){ft(e,n,s);return}vt(e,o,s)}}function X(e,t){for(let n of e)if(n.identifier===t)return n;return null}function be(e,t,n){let o=t.getBoundingClientRect(),s=o.left+o.width/2,i=o.top+o.height/2,l={x:e.clientX-s,y:e.clientY-i},u=ke(l,n);return{x:u.x/n,y:u.y/n}}function Re(e,t,n){let o=t.x*n,s=t.y*n;e.style.transform=`translate(${o}px, ${s}px)`}function _e(e){e.style.transform="translate(0px, 0px)"}var q=class{constructor({canvas:t,movePad:n,moveKnob:o,aimPad:s,aimKnob:i}){this.canvas=t,this.movePad=n,this.moveKnob=o,this.aimPad=s,this.aimKnob=i,this.keyboard=new Set,this.mouseAim={x:0,y:-1},this.touchMove={x:0,y:0},this.touchAim={x:0,y:0},this.hasAim=!1,this.moveTouchId=null,this.aimTouchId=null,this.aimTapStart=null,this.shootRequested=!1,this.playerScreenPos={x:t.width/2,y:t.height/2},this.handleKeyDown=this.onKeyDown.bind(this),this.handleKeyUp=this.onKeyUp.bind(this),this.handleMouseMove=this.onMouseMove.bind(this),this.handleMouseDown=this.onMouseDown.bind(this),this.handleMoveStart=this.onMoveTouchStart.bind(this),this.handleMoveMove=this.onMoveTouchMove.bind(this),this.handleMoveEnd=this.onMoveTouchEnd.bind(this),this.handleAimStart=this.onAimTouchStart.bind(this),this.handleAimMove=this.onAimTouchMove.bind(this),this.handleAimEnd=this.onAimTouchEnd.bind(this),this.attach()}attach(){window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.movePad.addEventListener("touchstart",this.handleMoveStart,{passive:!1}),this.movePad.addEventListener("touchmove",this.handleMoveMove,{passive:!1}),this.movePad.addEventListener("touchend",this.handleMoveEnd,{passive:!1}),this.movePad.addEventListener("touchcancel",this.handleMoveEnd,{passive:!1}),this.aimPad.addEventListener("touchstart",this.handleAimStart,{passive:!1}),this.aimPad.addEventListener("touchmove",this.handleAimMove,{passive:!1}),this.aimPad.addEventListener("touchend",this.handleAimEnd,{passive:!1}),this.aimPad.addEventListener("touchcancel",this.handleAimEnd,{passive:!1})}destroy(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.movePad.removeEventListener("touchstart",this.handleMoveStart),this.movePad.removeEventListener("touchmove",this.handleMoveMove),this.movePad.removeEventListener("touchend",this.handleMoveEnd),this.movePad.removeEventListener("touchcancel",this.handleMoveEnd),this.aimPad.removeEventListener("touchstart",this.handleAimStart),this.aimPad.removeEventListener("touchmove",this.handleAimMove),this.aimPad.removeEventListener("touchend",this.handleAimEnd),this.aimPad.removeEventListener("touchcancel",this.handleAimEnd)}onKeyDown(t){let n=t.key.toLowerCase();this.keyboard.add(n),n===" "&&(t.preventDefault(),this.shootRequested=!0)}onKeyUp(t){this.keyboard.delete(t.key.toLowerCase())}onMouseMove(t){let n=this.canvas.getBoundingClientRect(),o={x:(t.clientX-n.left)*(this.canvas.width/n.width),y:(t.clientY-n.top)*(this.canvas.height/n.height)};this.mouseAim=p({x:o.x-this.playerScreenPos.x,y:o.y-this.playerScreenPos.y}),(this.mouseAim.x||this.mouseAim.y)&&(this.hasAim=!0)}onMouseDown(){this.shootRequested=!0}onMoveTouchStart(t){if(this.moveTouchId!==null)return;let n=t.changedTouches[0];this.moveTouchId=n.identifier,this.onMoveTouchMove(t)}onMoveTouchMove(t){if(this.moveTouchId===null)return;t.preventDefault();let n=X(t.touches,this.moveTouchId);if(!n)return;let o=this.movePad.clientWidth*.34;this.touchMove=be(n,this.movePad,o),Re(this.moveKnob,this.touchMove,o)}onMoveTouchEnd(t){this.moveTouchId===null||!X(t.changedTouches,this.moveTouchId)||(this.moveTouchId=null,this.touchMove={x:0,y:0},_e(this.moveKnob))}onAimTouchStart(t){if(this.aimTouchId!==null)return;let n=t.changedTouches[0];this.aimTouchId=n.identifier,this.aimTapStart={x:n.clientX,y:n.clientY}}onAimTouchMove(t){if(this.aimTouchId===null)return;t.preventDefault();let n=X(t.touches,this.aimTouchId);if(!n)return;let o=this.aimPad.clientWidth*.34;this.touchAim=be(n,this.aimPad,o);let s=p(this.touchAim);(s.x||s.y)&&(this.touchAim=s,this.hasAim=!0),Re(this.aimKnob,this.touchAim,o)}onAimTouchEnd(t){if(this.aimTouchId===null)return;let n=X(t.changedTouches,this.aimTouchId);if(!n)return;(this.aimTapStart?Math.hypot(n.clientX-this.aimTapStart.x,n.clientY-this.aimTapStart.y):0)<14&&(this.shootRequested=!0),this.aimTouchId=null,this.aimTapStart=null,_e(this.aimKnob)}setPlayerScreenPosition(t,n){this.playerScreenPos={x:t,y:n}}getMovementVector(){if(this.moveTouchId!==null)return p(this.touchMove);let t=(this.keyboard.has("d")||this.keyboard.has("arrowright")?1:0)-(this.keyboard.has("a")||this.keyboard.has("arrowleft")?1:0),n=(this.keyboard.has("s")||this.keyboard.has("arrowdown")?1:0)-(this.keyboard.has("w")||this.keyboard.has("arrowup")?1:0);return p({x:t,y:n})}getAimVector(){return this.aimTouchId!==null||this.touchAim.x||this.touchAim.y?p(this.touchAim):this.hasAim?p(this.mouseAim):{x:0,y:0}}consumeShootRequested(){return this.shootRequested?(this.shootRequested=!1,!0):!1}};function G(e){return{elapsedSeconds:0,spawnAccumulator:0,completed:!1,completionAnnounced:!1,level:e}}function gt(e,t){return e.waves.find(n=>t>=n.start&&t<n.end)??e.waves[e.waves.length-1]}function De(e,t,n,o){if(e.completed)return;e.elapsedSeconds+=n,e.spawnAccumulator+=n;let s=gt(e.level,e.elapsedSeconds),i=e.level.spawnIntervalSeconds*(s.spawnMultiplier??1);for(;e.spawnAccumulator>=i&&(e.spawnAccumulator-=i,!(t.enemies.length>=K.MAX_ENEMIES));)o(s.type,s.pattern,e.level.difficulty);e.elapsedSeconds>=e.level.durationSeconds&&(e.completed=!0)}function Ne(e,t){let n=structuredClone(e.stats);return{id:e.id,name:e.name,baseStats:n,x:h.PLAYER_SPAWN_X,y:h.PLAYER_SPAWN_Y,prevX:h.PLAYER_SPAWN_X,prevY:h.PLAYER_SPAWN_Y,health:n.maxHealth,maxHealth:n.maxHealth,healthRegen:n.healthRegen,speed:n.speed,baseDamage:n.baseDamage,cooldownMs:n.cooldownMs,size:n.size,armorPercent:n.armorPercent,invulnerableMs:0,shootCooldownMs:0,aimDir:{x:0,y:-1},weapon:t,pickupRadius:S.COIN_PICKUP_BASE_RADIUS,damageMultiplier:1,projectileSpeedMultiplier:1,fireRateMultiplier:1}}function Oe(e){e.prevX=e.x,e.prevY=e.y}function ie(e,t){let n=p(t);(n.x||n.y)&&(e.aimDir=n)}function He(e,t,n,o=h){let s=p(t);e.x+=s.x*e.speed*n,e.y+=s.y*e.speed*n;let i=e.size,l=o.WIDTH-e.size,u=e.size,w=o.HEIGHT-e.size;e.x=Math.min(l,Math.max(i,e.x)),e.y=Math.min(w,Math.max(u,e.y)),e.health=Math.min(e.maxHealth,e.health+e.healthRegen*n),e.shootCooldownMs=Math.max(0,e.shootCooldownMs-n*1e3),e.invulnerableMs=Math.max(0,e.invulnerableMs-n*1e3)}function yt(e){return e.shootCooldownMs<=0}function We(e){return yt(e)?(e.shootCooldownMs=e.cooldownMs/e.fireRateMultiplier,!0):!1}function re(e,t){if(e.invulnerableMs>0)return 0;let n=Math.min(.85,Math.max(0,e.armorPercent)),o=t*(1-n);return e.health=Math.max(0,e.health-o),e.invulnerableMs=S.PLAYER_INVULN_MS_ON_HIT,o}function xt(e,t,n){if(!n||!t.effect)return;let{stat:o,mode:s,perLevel:i}=t.effect;if(s==="add"){e[o]+=i*n;return}s==="mult"&&(e[o]*=1+i*n)}function Ye(e,t,n){e.maxHealth=e.baseStats.maxHealth,e.healthRegen=e.baseStats.healthRegen,e.speed=e.baseStats.speed,e.baseDamage=e.baseStats.baseDamage,e.cooldownMs=e.baseStats.cooldownMs,e.size=e.baseStats.size,e.armorPercent=e.baseStats.armorPercent,e.pickupRadius=S.COIN_PICKUP_BASE_RADIUS,e.damageMultiplier=1,e.projectileSpeedMultiplier=1,e.fireRateMultiplier=1;for(let[o,s]of Object.entries(t)){let i=n[o];if(i){if(i.effect?.stat==="pickupRadius"){e.pickupRadius+=i.effect.perLevel*s;continue}if(i.effect?.stat==="damageMultiplier"){e.damageMultiplier*=1+i.effect.perLevel*s;continue}if(i.effect?.stat==="projectileSpeedMultiplier"){e.projectileSpeedMultiplier*=1+i.effect.perLevel*s;continue}if(i.effect?.stat==="fireRateMultiplier"){e.fireRateMultiplier*=1+i.effect.perLevel*s;continue}xt(e,i,s)}}e.health>e.maxHealth&&(e.health=e.maxHealth)}function ze(e,t){e.weapon=t}function le(e=K.MAX_PROJECTILES){return{items:Array.from({length:e},()=>({active:!1})),nextIndex:0}}function ce(e,t){let{items:n}=e;for(let o=0;o<n.length;o+=1){let s=(e.nextIndex+o)%n.length,i=n[s];if(!i.active)return i.active=!0,i.x=t.x,i.y=t.y,i.prevX=t.x,i.prevY=t.y,i.vx=t.vx,i.vy=t.vy,i.size=t.size??g.PROJECTILE,i.damage=t.damage??1,i.owner=t.owner??"player",i.ttl=t.ttl??2.5,i.pierceLeft=t.pierceLeft??0,i.special=t.special??"none",i.explosionRadius=t.explosionRadius??0,e.nextIndex=(s+1)%n.length,i}return null}function de(e){e.active=!1}function ue(e,t){for(let n of e.items)n.active&&t(n)}function Be(e,t,n=h){ue(e,o=>{o.prevX=o.x,o.prevY=o.y,o.x+=o.vx*t,o.y+=o.vy*t,o.ttl-=t,(o.ttl<=0||o.x<-32||o.y<-32||o.x>n.WIDTH+32||o.y>n.HEIGHT+32)&&de(o)})}function he(e,t){return e.x-e.size<t.x+t.size&&e.x+e.size>t.x-t.size&&e.y-e.size<t.y+t.size&&e.y+e.size>t.y-t.size}function Ue(e,t,n,o){ue(e,s=>{if(s.owner==="player"){for(let i of t)if(i.alive&&he(s,i)){if(i.health-=s.damage,i.flashTimer=i.flashDuration,n?.(i,s),i.health<=0&&(i.alive=!1,o?.(i,s)),s.special==="explosive"&&s.explosionRadius>0)for(let l of t){if(!l.alive||l===i)continue;let u=l.x-i.x,w=l.y-i.y;Math.hypot(u,w)<=s.explosionRadius&&(l.health-=s.damage*.4,l.flashTimer=l.flashDuration,l.health<=0&&(l.alive=!1,o?.(l,s)))}s.pierceLeft>0?s.pierceLeft-=1:de(s);break}}})}function Ke(e,t,n){ue(e,o=>{o.owner==="enemy"&&he(o,t)&&(n?.(o),de(o))})}function $e(e,t){for(let n of t)if(n.alive&&he(e,n))return n;return null}function Fe(e,t){return{x:T(e.prevX??e.x,e.x,t),y:T(e.prevY??e.y,e.y,t)}}function Xe(e,t,n,o){let{width:s,height:i}=t;e.clearRect(0,0,s,i),e.fillStyle=n.level.backgroundColor,e.fillRect(0,0,s,i),Ct(e,n,o),St(e,n,o),wt(e,n,o),Et(e,n,o)}function Et(e,t,n){let o=t.player,s=Fe(o,n);e.save(),e.fillStyle=x.PLAYER,e.beginPath(),e.arc(s.x,s.y,o.size,0,Math.PI*2),e.fill(),e.fillStyle=x.PLAYER_CORE,e.beginPath(),e.arc(s.x,s.y,Math.max(4,o.size*.38),0,Math.PI*2),e.fill();let i=t.aimDir,l=o.size+28;e.strokeStyle=x.AIM,e.lineWidth=3,e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(s.x+i.x*l,s.y+i.y*l),e.stroke(),e.restore()}function wt(e,t,n){for(let o of t.enemies){if(!o.alive)continue;let s=Fe(o,n);e.save(),e.fillStyle=o.flashTimer>0?x.ENEMY_FLASH:x.ENEMY,e.fillRect(s.x-o.size,s.y-o.size,o.size*2,o.size*2),e.restore()}}function St(e,t,n){for(let o of t.projectiles.items){if(!o.active)continue;let s=T(o.prevX??o.x,o.x,n),i=T(o.prevY??o.y,o.y,n);e.save(),e.fillStyle=o.owner==="enemy"?x.ENEMY_PROJECTILE:x.PLAYER_PROJECTILE;let l=o.owner==="enemy"?g.ENEMY_PROJECTILE:o.size;e.beginPath(),e.arc(s,i,l,0,Math.PI*2),e.fill(),e.restore()}}function Ct(e,t,n){for(let o of t.coins){if(!o.active)continue;let s=T(o.prevX??o.x,o.x,n),i=T(o.prevY??o.y,o.y,n);e.save(),e.fillStyle=x.COIN,e.strokeStyle=x.COIN_STROKE,e.lineWidth=2,e.beginPath(),e.arc(s,i,o.size??g.COIN,0,Math.PI*2),e.fill(),e.stroke(),e.restore()}}var pe={coins:0,ownedLevels:{}};function me(e){return{...e,ownedLevels:{...e.ownedLevels??{}}}}var V=class{constructor({storage:t,storageKey:n="shop",catalog:o}){this.storage=t,this.storageKey=n,this.catalog=new Map(o.map(s=>[s.id,s])),this.state=me(pe)}async init(t=pe){let n=await this.storage.get(this.storageKey);return this.state=me({...pe,...t,...n??{}}),this.state.ownedLevels||(this.state.ownedLevels={}),this.getSnapshot()}getSnapshot(){return me(this.state)}getLevel(t){return this.state.ownedLevels[t]??0}getCoins(){return this.state.coins}setCoins(t){this.state.coins=Math.max(0,Math.floor(t))}addCoins(t){this.setCoins(this.state.coins+t)}getItem(t){return this.catalog.get(t)??null}getNextCost(t){let n=this.getItem(t);if(!n)return 1/0;let o=this.getLevel(t);return o>=n.maxLevel?null:n.costs[o]}canAfford(t){let n=this.getNextCost(t);return n===null?!1:this.state.coins>=n}async persist(){await this.storage.set(this.storageKey,this.getSnapshot())}async buy(t){let n=this.getItem(t);if(!n)return{ok:!1,reason:"MAX_LEVEL"};let o=this.getLevel(t);if(o>=n.maxLevel)return{ok:!1,reason:"MAX_LEVEL"};let s=n.costs[o];return this.state.coins<s?{ok:!1,reason:"INSUFFICIENT_COINS"}:(this.state.coins-=s,this.state.ownedLevels[t]=o+1,await this.persist(),{ok:!0,itemId:t,level:this.state.ownedLevels[t],coins:this.state.coins,spent:s})}};function v(e){let t=document.getElementById(e);if(!t)throw new Error(`Missing DOM element: ${e}`);return t}function qe({onToggleShop:e,onCloseShop:t,onBuy:n,onToggleSfx:o,onApplyUpdate:s,onDismissHint:i}){let l={healthText:v("healthText"),scoreText:v("scoreText"),coinsText:v("coinsText"),bankCoinsText:v("bankCoinsText"),shopToggle:v("shopToggle"),shopClose:v("shopClose"),shopPanel:v("shopPanel"),shopItems:v("shopItems"),toastArea:v("toastArea"),hintOverlay:v("hintOverlay"),hintDismiss:v("hintDismiss"),updateBanner:v("updateBanner"),updateButton:v("updateButton"),sfxToggle:v("sfxToggle")};l.shopToggle.addEventListener("click",e),l.shopClose.addEventListener("click",t),l.hintDismiss.addEventListener("click",i),l.updateButton.addEventListener("click",s),l.sfxToggle.addEventListener("change",f=>o(f.target.checked));function u({health:f,maxHealth:D,score:d,runCoins:y,bankCoins:B}){l.healthText.textContent=`HP: ${Math.ceil(f)}/${Math.ceil(D)}`,l.scoreText.textContent=`Score: ${Math.floor(d)}`,l.coinsText.textContent=`Run Coins: ${y}`,l.bankCoinsText.textContent=`Bank Coins: ${B}`}function w(f){l.shopPanel.classList.toggle("hidden",!f)}function Y(f){l.hintOverlay.classList.toggle("hidden",!f)}function z(f){l.updateBanner.classList.toggle("hidden",!f)}function st(f){l.sfxToggle.checked=!!f}function at(f,D="info",d=1600){let y=document.createElement("div");y.className=`toast ${D}`,y.textContent=f,l.toastArea.appendChild(y),window.setTimeout(()=>{y.remove()},d)}function it(f,D){l.shopItems.innerHTML="";for(let d of f){let y=document.createElement("article");y.className="shop-item";let B=document.createElement("strong");B.textContent=`${d.name} (${d.kind})`,y.appendChild(B);let Q=document.createElement("div");Q.className="meta",Q.innerHTML=`<span>${d.description}</span><span>Level ${d.level}/${d.maxLevel}</span>`,y.appendChild(Q);let U=document.createElement("div");U.className="row";let rt=d.nextCost===null?"MAX":`Cost: ${d.nextCost}`,we=document.createElement("span");we.textContent=rt,U.appendChild(we);let b=document.createElement("button");b.type="button",b.textContent=d.nextCost===null?"Max":"Buy";let lt=!d.unlocked||d.nextCost===null||D<d.nextCost;b.disabled=lt,d.unlocked||(b.title=`Unlock: ${d.unlockText}`),b.addEventListener("click",()=>n(d.id)),U.appendChild(b),y.appendChild(U),l.shopItems.appendChild(y)}}return{renderHud:u,setShopOpen:w,showHint:Y,showToast:at,renderShopEntries:it,setSfxEnabled:st,showUpdateBanner:z}}var j=class{async get(t){throw new Error("StorageAdapter.get must be implemented")}async set(t,n){throw new Error("StorageAdapter.set must be implemented")}async remove(t){throw new Error("StorageAdapter.remove must be implemented")}async clear(){throw new Error("StorageAdapter.clear must be implemented")}async keys(){throw new Error("StorageAdapter.keys must be implemented")}};var J=class extends j{constructor(t="survivor"){super(),this.prefix=t}makeKey(t){return`${this.prefix}:${t}`}async get(t){let n=localStorage.getItem(this.makeKey(t));return n===null?null:JSON.parse(n)}async set(t,n){localStorage.setItem(this.makeKey(t),JSON.stringify(n))}async remove(t){localStorage.removeItem(this.makeKey(t))}async clear(){let t=await this.keys();for(let n of t)localStorage.removeItem(this.makeKey(n))}async keys(){let t=[];for(let n=0;n<localStorage.length;n+=1){let o=localStorage.key(n);!o||!o.startsWith(`${this.prefix}:`)||t.push(o.slice(this.prefix.length+1))}return t}};var A=new J("survivor"),E=Me(),H=document.getElementById("gameCanvas"),ge=H.getContext("2d"),Mt=document.getElementById("movePad"),Lt=document.getElementById("moveKnob"),kt=document.getElementById("aimPad"),It=document.getElementById("aimKnob");H.width=h.WIDTH;H.height=h.HEIGHT;ge.imageSmoothingEnabled=!1;ge.fillStyle=x.HUD_TEXT;var W=$t(),m=new V({storage:A,storageKey:"shop",catalog:W}),k=null,Je=null,Ge=!1,N=!1,fe=!1,Ve=new Set,c=qe({onToggleShop:()=>{N=!N,c.setShopOpen(N),Z()},onCloseShop:()=>{N=!1,c.setShopOpen(!1)},onBuy:async e=>{let t=W.find(o=>o.id===e);if(!t)return;if(!Ee(t.unlockCondition,r)){c.showToast(`Locked: ${ot(t.unlockCondition)}`,"error");return}let n=await m.buy(e);if(!n.ok){let o=n.reason==="MAX_LEVEL"?"Item already maxed":"Not enough coins";c.showToast(o,"error");return}Ut(e),E.play("shopBuy"),c.showToast(`Purchased ${t.name}`,"success"),et(),xe(),Z(),_()},onToggleSfx:async e=>{O.sfxEnabled=e,E.setEnabled(e),await A.set(I.SETTINGS,O)},onApplyUpdate:()=>{let e=Je??k?.waiting;e&&e.postMessage({type:"SKIP_WAITING"})},onDismissHint:async()=>{c.showHint(!1),ye=!0,await A.set(I.HINT_SEEN,!0)}}),R=new q({canvas:H,movePad:Mt,moveKnob:Lt,aimPad:kt,aimKnob:It}),Ze=new F({update:Nt,render:e=>Xe(ge,H,a,e)}),r=structuredClone(ee),O=structuredClone(te),ye=!1,a={levelIndex:0,level:L[0],levelRuntime:G(L[0]),player:null,enemies:[],coins:[],projectiles:le(),score:0,runCoins:0,elapsedSeconds:0,gameOver:!1,gameWon:!1,enemyIdSeed:0,coinIdSeed:0,aimDir:{x:0,y:-1},moveDir:{x:0,y:0},hasExplicitAim:!1};await Tt();async function Tt(){await Pt(),await At(),E.setEnabled(O.sfxEnabled),c.setSfxEnabled(O.sfxEnabled),c.showHint(!ye),tt(!0),Z(),xe(),Ze.start(),Ft()}async function Pt(){let[e,t,n]=await Promise.all([A.get(I.PROFILE),A.get(I.SETTINGS),A.get(I.HINT_SEEN)]);r={...structuredClone(ee),...e??{}},r.levelsCompleted=Array.isArray(r.levelsCompleted)?r.levelsCompleted:[],r.perLevelBest={...r.perLevelBest??{}},r.ownedLevels={...r.ownedLevels??{}},r.unlockedCharacters=je(["runner",...r.unlockedCharacters??[]]),r.unlockedWeapons=je(["pulse",...r.unlockedWeapons??[]]),O={...structuredClone(te),...t??{}},ye=!!n,Qe()}async function At(){let e={coins:r.bankCoins,ownedLevels:{...r.ownedLevels,...bt(r)}},t=await m.init(e);r.bankCoins=t.coins,r.ownedLevels={...t.ownedLevels}}function Qe(){r.unlockedCharacters.includes(r.selectedCharacterId)||(r.selectedCharacterId=r.unlockedCharacters[0]??"runner"),r.unlockedWeapons.includes(r.selectedWeaponId)||(r.selectedWeaponId=r.unlockedWeapons[0]??"pulse")}function je(e){return[...new Set(e)]}function bt(e){let t={};for(let n of e.unlockedCharacters)n!=="runner"&&(t[`character:${n}`]=1);for(let n of e.unlockedWeapons)n!=="pulse"&&(t[`weapon:${n}`]=1);return t}function Rt(){return oe[r.selectedCharacterId]??$[0]}function _t(e){let t=C[r.selectedWeaponId];if(t&&r.unlockedWeapons.includes(t.id))return t;let n=C[e.startingWeaponId]??C.pulse;return r.unlockedWeapons.includes(n.id)?n:C.pulse}function Dt(){let e=m.getSnapshot().ownedLevels,t={};for(let[n,o]of Object.entries(e))ae[n]&&(t[n]=o);return t}function et(){if(!a.player)return;let e=Dt();Ye(a.player,e,ae)}function tt(e){e&&(r.playCount+=1);let t=Math.max(1,r.playCount);a.levelIndex=(t-1)%L.length,a.level=L[a.levelIndex],a.levelRuntime=G(a.level),a.enemies.length=0,a.coins.length=0,a.projectiles=le(),a.score=0,a.runCoins=0,a.elapsedSeconds=0,a.gameOver=!1,a.gameWon=!1;let n=Rt(),o=_t(n);a.player=Ne(n,o),et(),a.aimDir={x:0,y:-1},a.moveDir={x:0,y:0},a.hasExplicitAim=!1,c.showToast(`Entering ${a.level.name}`,"success",1500),_()}function Nt(e){if(!a.player)return;a.elapsedSeconds+=e,Oe(a.player);for(let s of a.enemies)Pe(s);for(let s of a.coins)s.prevX=s.x,s.prevY=s.y;a.moveDir=R.getMovementVector();let t=R.getAimVector();if((t.x||t.y)&&(a.aimDir=p(t),a.hasExplicitAim=!0),ie(a.player,a.aimDir),R.setPlayerScreenPosition(a.player.x,a.player.y),a.gameOver){R.consumeShootRequested()&&tt(!0);return}if(He(a.player,a.moveDir,e,h),R.consumeShootRequested()){let s=Ot();a.aimDir=p(s),ie(a.player,a.aimDir),Ht(a.aimDir)}De(a.levelRuntime,a,e,(s,i,l)=>{let u=Te(++a.enemyIdSeed,s,i,l,h);a.enemies.push(u)});for(let s of a.enemies)Ae(s,e,a.player,a.elapsedSeconds,(i,l)=>{ce(a.projectiles,{x:i.x,y:i.y,vx:l.x*i.shotSpeed,vy:l.y*i.shotSpeed,owner:"enemy",size:g.ENEMY_PROJECTILE,damage:i.shotDamage,ttl:4})});Be(a.projectiles,e,h),Wt(e),Ue(a.projectiles,a.enemies,()=>{E.play("hit")},s=>{a.score+=Math.round(s.maxHealth*4),Yt(s.x,s.y,Math.max(1,Math.round(s.size/12))),E.play("enemyDeath")}),Ke(a.projectiles,a.player,s=>{re(a.player,s.damage)>0&&E.play("hit")});let o=$e(a.player,a.enemies);o&&re(a.player,o.contactDamage*e*6.2)>0&&E.play("hit"),zt(),a.score+=e*7,a.player.health<=0&&nt(!1),a.levelRuntime.completed&&a.enemies.length===0&&Bt(),Kt(),xe(),N&&Z(),Math.floor(a.elapsedSeconds*10)%13===0&&_()}function Ot(){return a.hasExplicitAim&&(a.aimDir.x||a.aimDir.y)?a.aimDir:a.moveDir.x||a.moveDir.y?a.moveDir:{x:0,y:S.SHOOT_FALLBACK_Y}}function Ht(e){if(!We(a.player))return;let t=a.player.weapon,n=Math.atan2(e.y,e.x),o=t.spreadDegrees*Math.PI/180,s=t.projectilesPerShot;for(let i=0;i<s;i+=1){let u=((s===1?.5:i/(s-1))-.5)*o,w=P(n+u),Y=(t.damage+a.player.baseDamage)*a.player.damageMultiplier,z=t.projectileSpeed*a.player.projectileSpeedMultiplier;ce(a.projectiles,{x:a.player.x+w.x*(a.player.size+4),y:a.player.y+w.y*(a.player.size+4),vx:w.x*z,vy:w.y*z,owner:"player",size:g.PROJECTILE,damage:Y,ttl:2,special:t.special,pierceLeft:t.special==="piercing"?1:0,explosionRadius:t.special==="explosive"?32:0})}E.play("shoot")}function Wt(e){let t=a.player.pickupRadius;for(let n of a.coins){if(!n.active)continue;if(n.age+=e,n.vx*=.94,n.vy*=.94,n.x+=n.vx*e,n.y+=n.vy*e,n.age>S.COIN_LIFETIME_SECONDS){n.active=!1;continue}let o=a.player.x-n.x,s=a.player.y-n.y;Math.hypot(o,s)<=t&&(n.active=!1,a.runCoins+=n.value,m.addCoins(n.value),r.bankCoins=m.getCoins(),r.totalCoinsCollected+=n.value,E.play("coin"),_())}}function Yt(e,t,n){for(let o=0;o<n&&!(a.coins.length>=180);o+=1){let s=Math.random()*Math.PI*2,i=30+Math.random()*60;a.coins.push({id:++a.coinIdSeed,active:!0,x:e,y:t,prevX:e,prevY:t,vx:Math.cos(s)*i,vy:Math.sin(s)*i,value:1,size:g.COIN,age:0})}}function zt(){a.enemies=a.enemies.filter(e=>e.alive),a.coins=a.coins.filter(e=>e.active)}function Bt(){r.levelsCompleted.includes(a.level.id)||r.levelsCompleted.push(a.level.id);let e=r.perLevelBest[a.level.id]??0;if(r.perLevelBest[a.level.id]=Math.max(e,Math.floor(a.score)),a.levelIndex<L.length-1){a.levelIndex+=1,a.level=L[a.levelIndex],a.levelRuntime=G(a.level),c.showToast(`Level clear. Entering ${a.level.name}`,"success",1800),E.play("levelUp"),_();return}nt(!0)}function nt(e){a.gameOver=!0,a.gameWon=e,r.highScore=Math.max(r.highScore,Math.floor(a.score)),r.bankCoins=m.getCoins(),r.ownedLevels=m.getSnapshot().ownedLevels,_();let t=e?`Run complete! Score ${Math.floor(a.score)}. Tap fire to restart.`:`Downed! Score ${Math.floor(a.score)}. Tap fire to retry.`;c.showToast(t,e?"success":"error",2100)}function xe(){c.renderHud({health:a.player.health,maxHealth:a.player.maxHealth,score:a.score,runCoins:a.runCoins,bankCoins:m.getCoins()})}function Z(){let e=W.map(t=>{let n=m.getLevel(t.id),o=m.getNextCost(t.id);return{id:t.id,name:t.name,description:t.description,kind:t.kind,level:n,maxLevel:t.maxLevel,nextCost:o,unlocked:Ee(t.unlockCondition,r),unlockText:ot(t.unlockCondition)}});c.renderShopEntries(e,m.getCoins())}function Ut(e){let t=W.find(n=>n.id===e);t&&(t.reward?.type==="character"&&(r.unlockedCharacters.includes(t.reward.id)||(r.unlockedCharacters.push(t.reward.id),r.selectedCharacterId=t.reward.id,c.showToast(`${oe[t.reward.id].name} unlocked`,"success",1800))),t.reward?.type==="weapon"&&(r.unlockedWeapons.includes(t.reward.id)||(r.unlockedWeapons.push(t.reward.id),r.selectedWeaponId=t.reward.id,a.player&&ze(a.player,C[t.reward.id]),c.showToast(`${C[t.reward.id].name} unlocked`,"success",1800))),r.bankCoins=m.getCoins(),r.ownedLevels=m.getSnapshot().ownedLevels)}function Kt(){for(let e of W)m.getLevel(e.id)>0||Ee(e.unlockCondition,r)&&(Ve.has(e.id)||(Ve.add(e.id),c.showToast(`Unlocked in shop: ${e.name}`,"success",1800),E.play("levelUp")))}function _(){fe||(fe=!0,window.setTimeout(async()=>{fe=!1,r.bankCoins=m.getCoins(),r.ownedLevels=m.getSnapshot().ownedLevels,Qe(),await Promise.all([A.set(I.PROFILE,r),m.persist()])},100))}function $t(){let e=se.map(o=>({...o,unlockCondition:{type:"default",value:0}})),t=$.filter(o=>o.id!=="runner").map((o,s)=>({id:`character:${o.id}`,name:`Unlock ${o.name}`,kind:"character",description:"Playable character unlock.",maxLevel:1,costs:[120+s*72],unlockCondition:o.unlockCondition,reward:{type:"character",id:o.id}})),n=[{id:"twin",unlockCondition:{type:"playCount",value:2},cost:170},{id:"nova",unlockCondition:{type:"levelsCompleted",value:1},cost:300},{id:"rail",unlockCondition:{type:"score",value:1800},cost:390}].map(o=>({id:`weapon:${o.id}`,name:`Unlock ${C[o.id].name}`,kind:"weapon",description:"Weapon unlock for future runs.",maxLevel:1,costs:[o.cost],unlockCondition:o.unlockCondition,reward:{type:"weapon",id:o.id}}));return[...e,...t,...n]}function Ee(e,t){return!e||e.type==="default"?!0:e.type==="playCount"?t.playCount>=e.value:e.type==="coins"?t.totalCoinsCollected>=e.value:e.type==="levelsCompleted"?t.levelsCompleted.length>=e.value:e.type==="score"?t.highScore>=e.value:!1}function ot(e){return!e||e.type==="default"?"Available":e.type==="playCount"?`Play ${e.value} runs`:e.type==="coins"?`Collect ${e.value} total coins`:e.type==="levelsCompleted"?`Complete ${e.value} levels`:e.type==="score"?`Reach high score ${e.value}`:"Progress required"}async function Ft(){if(!("serviceWorker"in navigator)){c.showToast("Service workers unsupported in this browser","error",2e3);return}try{k=await navigator.serviceWorker.register("./service-worker.js",{scope:"./"}),k.waiting&&ve(k.waiting),k.addEventListener("updatefound",()=>{let e=k.installing;e&&e.addEventListener("statechange",()=>{e.state==="installed"&&navigator.serviceWorker.controller&&ve(k.waiting??e)})}),navigator.serviceWorker.addEventListener("message",e=>{e.data?.type==="SWUPDATEAVAILABLE"&&ve(k?.waiting??null)}),navigator.serviceWorker.addEventListener("controllerchange",()=>{Ge||(Ge=!0,window.location.reload())})}catch(e){console.error("Service worker registration failed",e),c.showToast("Offline mode unavailable","error",1700)}}function ve(e){Je=e,c.showUpdateBanner(!0),E.play("updateAvailable")}window.addEventListener("beforeunload",()=>{R.destroy(),Ze.stop()});
