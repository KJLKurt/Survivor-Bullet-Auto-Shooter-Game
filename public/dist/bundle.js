(()=>{var l={targetFps:60,fixedStepSec:.016666666666666666,maxStepUpdates:6,arenaPadding:16,runDurationSec:95,coinBasePickupRadius:22,coinLifetimeSec:18,defaultCritChance:.05,defaultCritMultiplier:1.55,controls:{joystickRadius:52,deadzone:.17},palette:{text:"#eff7ff",player:"#61dafb",enemy:"#ff7b7b",enemyFast:"#ffb86c",enemyTank:"#c77dff",enemyBoss:"#ff3e6c",projectileFriendly:"#c0ff4b",projectileEnemy:"#ffcf6d",coin:"#f9d65a"},sizes:{player:18,enemySmall:16,enemyMedium:24,enemyLarge:36,projectile:6,coin:8}},M={profile:"survivor_profile_v1",sfxEnabled:"survivor_sfx_enabled"};var ve={shoot:[{frequency:680,duration:.03,type:"square",gain:.08},{frequency:520,duration:.02,type:"square",gain:.06}],hit:[{frequency:140,duration:.05,type:"triangle",gain:.07}],enemyDeath:[{frequency:380,duration:.04,type:"sawtooth",gain:.07},{frequency:220,duration:.06,type:"sawtooth",gain:.06}],coin:[{frequency:740,duration:.05,type:"triangle",gain:.07},{frequency:930,duration:.05,type:"triangle",gain:.05}],levelUp:[{frequency:440,duration:.05,type:"sine",gain:.08},{frequency:620,duration:.06,type:"sine",gain:.07},{frequency:820,duration:.08,type:"sine",gain:.06}],shopBuy:[{frequency:520,duration:.06,type:"sine",gain:.06}],updateAvailable:[{frequency:350,duration:.07,type:"triangle",gain:.06}]},B=class{constructor(e=!0){this.enabled=e,this.registered=new Map,this.ctx=null,Object.entries(ve).forEach(([t,s])=>{this.register(t,()=>this.playPattern(s))})}initContext(){if(!this.ctx&&typeof window<"u"){let e=window.AudioContext||window.webkitAudioContext;e&&(this.ctx=new e)}return this.ctx}setEnabled(e){this.enabled=!!e}register(e,t){this.registered.set(e,t)}async play(e){if(!this.enabled)return;let t=this.initContext();if(!t)return;t.state==="suspended"&&await t.resume();let s=this.registered.get(e);if(s){if(typeof s=="function"){s(t);return}if(s instanceof AudioBuffer){let r=t.createBufferSource();r.buffer=s,r.connect(t.destination),r.start()}}}playPattern(e){let t=this.initContext();if(!t)return;let s=t.currentTime;e.forEach(r=>{let a=t.createOscillator(),i=t.createGain();a.frequency.value=r.frequency,a.type=r.type||"sine",i.gain.setValueAtTime(1e-4,s),i.gain.exponentialRampToValueAtTime(r.gain||.06,s+.005),i.gain.exponentialRampToValueAtTime(1e-4,s+r.duration),a.connect(i),i.connect(t.destination),a.start(s),a.stop(s+r.duration+.01),s+=r.duration*.75})}};var g=[{id:"rookie",name:"Rookie",description:"Balanced baseline survivor.",baseStats:{maxHealth:110,healthRegen:.2,speed:180,baseDamage:1,cooldown:1,size:18,armor:.04},startingWeaponId:"pistol",unlockCondition:{type:"default"}},{id:"runner",name:"Runner",description:"Very fast but fragile.",baseStats:{maxHealth:80,healthRegen:.12,speed:240,baseDamage:.95,cooldown:.9,size:16,armor:.01},startingWeaponId:"smg",unlockCondition:{type:"coins",value:150}},{id:"tank",name:"Tank",description:"Huge health pool and armor.",baseStats:{maxHealth:180,healthRegen:.08,speed:135,baseDamage:1,cooldown:1.05,size:24,armor:.16},startingWeaponId:"shotgun",unlockCondition:{type:"coins",value:240}},{id:"sharpshooter",name:"Sharpshooter",description:"High single-target damage, slower shots.",baseStats:{maxHealth:90,healthRegen:.1,speed:170,baseDamage:1.35,cooldown:1.2,size:17,armor:.02},startingWeaponId:"sniper",unlockCondition:{type:"score",value:900}},{id:"engineer",name:"Engineer",description:"Deploys a temporary turret burst as special.",baseStats:{maxHealth:115,healthRegen:.15,speed:175,baseDamage:1.05,cooldown:.95,size:18,armor:.05},startingWeaponId:"turret_blaster",unlockCondition:{type:"playCount",value:3}},{id:"medic",name:"Medic",description:"Passive regeneration specialist.",baseStats:{maxHealth:100,healthRegen:.65,speed:160,baseDamage:.95,cooldown:1,size:18,armor:.03},startingWeaponId:"medic_pistol",unlockCondition:{type:"coins",value:300}},{id:"berserker",name:"Berserker",description:"Damage ramps up when health is low.",baseStats:{maxHealth:125,healthRegen:.05,speed:190,baseDamage:1.15,cooldown:.95,size:19,armor:.04},startingWeaponId:"cleaver",unlockCondition:{type:"playCount",value:6}},{id:"scout",name:"Scout",description:"Small hitbox and agile movement.",baseStats:{maxHealth:85,healthRegen:.18,speed:235,baseDamage:1,cooldown:.92,size:14,armor:.01},startingWeaponId:"burst_rifle",unlockCondition:{type:"score",value:1600}},{id:"demolisher",name:"Demolisher",description:"Explosive rounds with slow cadence.",baseStats:{maxHealth:130,healthRegen:.09,speed:150,baseDamage:1.25,cooldown:1.18,size:20,armor:.08},startingWeaponId:"grenade_launcher",unlockCondition:{type:"coins",value:430}},{id:"ghost",name:"Ghost",description:"Can phase briefly to avoid damage.",baseStats:{maxHealth:76,healthRegen:.12,speed:215,baseDamage:1.12,cooldown:.98,size:15,armor:.02},startingWeaponId:"phantom_blade",unlockCondition:{type:"levelsCompleted",value:2}}];function H(n){return g.find(e=>e.id===n)||g[0]}var k=[{id:"reinforced_plating",name:"Reinforced Plating",description:"Raises max health.",type:"playerBoost",levels:[{cost:60,statDeltas:{maxHealthPct:.08}},{cost:110,statDeltas:{maxHealthPct:.07}},{cost:180,statDeltas:{maxHealthPct:.06}},{cost:260,statDeltas:{maxHealthPct:.05}}]},{id:"lightweight_boots",name:"Lightweight Boots",description:"Improves movement speed.",type:"playerBoost",levels:[{cost:55,statDeltas:{speedPct:.07}},{cost:100,statDeltas:{speedPct:.06}},{cost:160,statDeltas:{speedPct:.05}},{cost:240,statDeltas:{speedPct:.04}}]},{id:"auto_loader",name:"Auto-Loader",description:"Reduces weapon cooldown.",type:"weaponUpgrade",levels:[{cost:70,statDeltas:{cooldownPct:-.08}},{cost:130,statDeltas:{cooldownPct:-.07}},{cost:210,statDeltas:{cooldownPct:-.06}},{cost:300,statDeltas:{cooldownPct:-.05}}]},{id:"high_velocity_rounds",name:"High-Velocity Rounds",description:"Increases projectile speed.",type:"weaponUpgrade",levels:[{cost:65,statDeltas:{projectileSpeedPct:.1}},{cost:120,statDeltas:{projectileSpeedPct:.08}},{cost:190,statDeltas:{projectileSpeedPct:.07}}]},{id:"piercing_rounds",name:"Piercing Rounds",description:"Chance for shots to pierce enemies.",type:"weaponUpgrade",levels:[{cost:80,statDeltas:{piercingChance:.1}},{cost:140,statDeltas:{piercingChance:.08}},{cost:220,statDeltas:{piercingChance:.07}}]},{id:"rapid_fire_mod",name:"Rapid Fire Mod",description:"Adds occasional bonus projectile.",type:"weaponUpgrade",levels:[{cost:95,statDeltas:{projectilesBonus:.2}},{cost:165,statDeltas:{projectilesBonus:.18}},{cost:250,statDeltas:{projectilesBonus:.15}}]},{id:"nano_healer",name:"Nano-Healer",description:"Passive healing while fighting.",type:"passive",levels:[{cost:85,statDeltas:{healthRegenFlat:.12}},{cost:150,statDeltas:{healthRegenFlat:.1}},{cost:230,statDeltas:{healthRegenFlat:.08}},{cost:320,statDeltas:{healthRegenFlat:.07}}]},{id:"coin_magnet",name:"Coin Magnet",description:"Wider coin pickup radius.",type:"passive",levels:[{cost:60,statDeltas:{coinMagnetFlat:8}},{cost:105,statDeltas:{coinMagnetFlat:7}},{cost:170,statDeltas:{coinMagnetFlat:6}},{cost:250,statDeltas:{coinMagnetFlat:5}}]},{id:"shield_generator",name:"Shield Generator",description:"Chance to nullify incoming hit.",type:"passive",levels:[{cost:115,statDeltas:{shieldChance:.08}},{cost:195,statDeltas:{shieldChance:.06}},{cost:285,statDeltas:{shieldChance:.05}}]},{id:"explosive_rounds",name:"Explosive Rounds",description:"Adds splash damage radius.",type:"weaponUpgrade",levels:[{cost:120,statDeltas:{explosiveRadius:12}},{cost:210,statDeltas:{explosiveRadius:8}},{cost:320,statDeltas:{explosiveRadius:6}}]},{id:"critical_tuner",name:"Critical Tuner",description:"Raises crit chance and crit power.",type:"passive",levels:[{cost:110,statDeltas:{critChance:.05,critDamage:.08}},{cost:200,statDeltas:{critChance:.04,critDamage:.07}},{cost:300,statDeltas:{critChance:.03,critDamage:.06}}]},{id:"ammo_reserve",name:"Ammo Reserve",description:"Mitigates cooldown penalties and improves stability.",type:"passive",levels:[{cost:70,statDeltas:{cooldownPenaltyReduction:.05}},{cost:130,statDeltas:{cooldownPenaltyReduction:.04}},{cost:210,statDeltas:{cooldownPenaltyReduction:.03}},{cost:290,statDeltas:{cooldownPenaltyReduction:.03}}]}];var w=[{id:"level1",name:"Neon Yard",arenaSize:{width:900,height:1600},backgroundColor:"#13263c",spawnPatterns:[{id:"l1-a",startSec:0,endSec:30,intervalSec:1.6,enemyType:"grunt",count:2,bulletPattern:"radial"},{id:"l1-b",startSec:25,endSec:70,intervalSec:2.4,enemyType:"runner",count:2,bulletPattern:"aimedBurst"},{id:"l1-c",startSec:60,endSec:95,intervalSec:2.9,enemyType:"tankette",count:1,bulletPattern:"wave"}],music:null,unlockCondition:{type:"default"}},{id:"level2",name:"Foundry District",arenaSize:{width:1024,height:1800},backgroundColor:"#2b1f31",spawnPatterns:[{id:"l2-a",startSec:0,endSec:40,intervalSec:1.3,enemyType:"runner",count:3,bulletPattern:"spiral"},{id:"l2-b",startSec:20,endSec:95,intervalSec:2.1,enemyType:"grunt",count:3,bulletPattern:"aimedBurst"},{id:"l2-c",startSec:48,endSec:95,intervalSec:6.8,enemyType:"miniBoss",count:1,bulletPattern:"radial"}],music:null,unlockCondition:{type:"playCount",value:2}},{id:"level3",name:"Void Citadel",arenaSize:{width:1180,height:2100},backgroundColor:"#1f1f30",spawnPatterns:[{id:"l3-a",startSec:0,endSec:95,intervalSec:1.1,enemyType:"runner",count:4,bulletPattern:"spiral"},{id:"l3-b",startSec:10,endSec:95,intervalSec:1.9,enemyType:"tankette",count:2,bulletPattern:"wave"},{id:"l3-c",startSec:35,endSec:95,intervalSec:3.8,enemyType:"miniBoss",count:1,bulletPattern:"radial"},{id:"l3-d",startSec:70,endSec:95,intervalSec:8.2,enemyType:"boss",count:1,bulletPattern:"multiPhase"}],music:null,unlockCondition:{type:"levelsCompleted",value:1}}];function q(n){return w.find(e=>e.id===n)||w[0]}var v=[{id:"pistol",name:"Sidearm Pistol",cooldownMs:420,projectileSpeed:420,damage:14,spreadDegrees:0,projectilesPerShot:1,special:"none"},{id:"smg",name:"Street SMG",cooldownMs:150,projectileSpeed:450,damage:6,spreadDegrees:8,projectilesPerShot:1,special:"none"},{id:"shotgun",name:"Pump Shotgun",cooldownMs:760,projectileSpeed:340,damage:9,spreadDegrees:28,projectilesPerShot:5,special:"none"},{id:"sniper",name:"Needle Rifle",cooldownMs:980,projectileSpeed:620,damage:36,spreadDegrees:0,projectilesPerShot:1,special:"piercing"},{id:"turret_blaster",name:"Engineer Blaster",cooldownMs:340,projectileSpeed:410,damage:11,spreadDegrees:6,projectilesPerShot:2,special:"none"},{id:"medic_pistol",name:"Medic Burst",cooldownMs:380,projectileSpeed:430,damage:10,spreadDegrees:4,projectilesPerShot:1,special:"healBoost"},{id:"cleaver",name:"Rage Cleaver",cooldownMs:320,projectileSpeed:250,damage:20,spreadDegrees:14,projectilesPerShot:1,special:"shortRange"},{id:"burst_rifle",name:"Scout Burst",cooldownMs:510,projectileSpeed:500,damage:9,spreadDegrees:9,projectilesPerShot:3,special:"none"},{id:"grenade_launcher",name:"Arc Launcher",cooldownMs:940,projectileSpeed:300,damage:30,spreadDegrees:5,projectilesPerShot:1,special:"explosive"},{id:"phantom_blade",name:"Ghost Chakram",cooldownMs:540,projectileSpeed:470,damage:15,spreadDegrees:12,projectilesPerShot:2,special:"piercing"}];function U(n){return v.find(e=>e.id===n)||v[0]}function xe(n,e,t,s=l.maxStepUpdates){let r=Math.min(e,.25),a=n+r,i=0;for(;a>=t&&i<s;)a-=t,i+=1;return i===s&&a>=t&&(a=0),{accumulator:a,steps:i}}var P=class{constructor({update:e,render:t,stepSec:s=l.fixedStepSec,maxUpdates:r=l.maxStepUpdates}){this.update=e,this.render=t,this.stepSec=s,this.maxUpdates=r,this.running=!1,this.lastTime=0,this.accumulator=0,this.rafId=0,this.tick=this.tick.bind(this)}start(){this.running||(this.running=!0,this.lastTime=performance.now(),this.rafId=requestAnimationFrame(this.tick))}stop(){this.running=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=0)}runFrame(e){let t=xe(this.accumulator,e,this.stepSec,this.maxUpdates);this.accumulator=t.accumulator;for(let r=0;r<t.steps;r+=1)this.update(this.stepSec);let s=this.accumulator/this.stepSec;return this.render(s),t.steps}tick(e){if(!this.running)return;let t=(e-this.lastTime)/1e3;this.lastTime=e,this.runFrame(t),this.rafId=requestAnimationFrame(this.tick)}};function S(n,e,t){return Math.max(e,Math.min(t,n))}function ke(n,e){return Math.hypot(n,e)}function m(n,e){let t=ke(n,e);return t?{x:n/t,y:e/t}:{x:0,y:0}}function x(n){return{x:Math.cos(n),y:Math.sin(n)}}function $(n,e){return Math.atan2(e.y-n.y,e.x-n.x)}var D=class{constructor({canvas:e,joystickZone:t,joystickKnob:s,shootButton:r,specialButton:a}){this.canvas=e,this.joystickZone=t,this.joystickKnob=s,this.shootButton=r,this.specialButton=a,this.moveVector={x:0,y:0},this.lookVector={x:0,y:-1},this.keyboard=new Set,this.shooting=!1,this.specialQueued=!1,this.joystickPointerId=null,this.joystickCenter={x:0,y:0},this.boundKeyDown=i=>this.onKeyDown(i),this.boundKeyUp=i=>this.onKeyUp(i),this.boundMouseMove=i=>this.onMouseMove(i)}attach(){window.addEventListener("keydown",this.boundKeyDown),window.addEventListener("keyup",this.boundKeyUp),window.addEventListener("mousemove",this.boundMouseMove),this.shootButton.addEventListener("pointerdown",()=>{this.shooting=!0}),this.shootButton.addEventListener("pointerup",()=>{this.shooting=!1}),this.shootButton.addEventListener("pointercancel",()=>{this.shooting=!1}),this.specialButton.addEventListener("pointerdown",()=>{this.specialQueued=!0}),this.joystickZone.addEventListener("pointerdown",e=>this.onJoystickDown(e)),this.joystickZone.addEventListener("pointermove",e=>this.onJoystickMove(e)),this.joystickZone.addEventListener("pointerup",e=>this.onJoystickUp(e)),this.joystickZone.addEventListener("pointercancel",e=>this.onJoystickUp(e))}destroy(){window.removeEventListener("keydown",this.boundKeyDown),window.removeEventListener("keyup",this.boundKeyUp),window.removeEventListener("mousemove",this.boundMouseMove)}onKeyDown(e){this.keyboard.add(e.key.toLowerCase()),e.key===" "&&(this.shooting=!0,e.preventDefault()),(e.key.toLowerCase()==="x"||e.key==="Shift")&&(this.specialQueued=!0)}onKeyUp(e){this.keyboard.delete(e.key.toLowerCase()),e.key===" "&&(this.shooting=!1)}onMouseMove(e){let t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,r=e.clientY-t.top,a={x:t.width/2,y:t.height/2};this.lookVector=m(s-a.x,r-a.y)}onJoystickDown(e){this.joystickPointerId=e.pointerId,this.joystickZone.setPointerCapture(e.pointerId);let t=this.joystickZone.getBoundingClientRect();this.joystickCenter={x:t.left+t.width/2,y:t.top+t.height/2},this.onJoystickMove(e)}onJoystickMove(e){if(e.pointerId!==this.joystickPointerId)return;let t=e.clientX-this.joystickCenter.x,s=e.clientY-this.joystickCenter.y,r=l.controls.joystickRadius,a=S(t/r,-1,1),i=S(s/r,-1,1),c=m(a,i),d=Math.min(1,Math.hypot(a,i));this.moveVector={x:c.x*d,y:c.y*d},this.joystickKnob.style.transform=`translate(${this.moveVector.x*r*.55}px, ${this.moveVector.y*r*.55}px)`}onJoystickUp(e){e.pointerId===this.joystickPointerId&&(this.joystickPointerId=null,this.moveVector={x:0,y:0},this.joystickKnob.style.transform="translate(0, 0)")}getMovement(){let e=this.moveVector.x,t=this.moveVector.y;(this.keyboard.has("a")||this.keyboard.has("arrowleft"))&&(e-=1),(this.keyboard.has("d")||this.keyboard.has("arrowright"))&&(e+=1),(this.keyboard.has("w")||this.keyboard.has("arrowup"))&&(t-=1),(this.keyboard.has("s")||this.keyboard.has("arrowdown"))&&(t+=1);let s=m(e,t);return Math.hypot(e,t)<l.controls.deadzone?{x:0,y:0}:s}getLookDirection(e={x:0,y:-1}){return this.lookVector.x===0&&this.lookVector.y===0?e:this.lookVector}isShooting(){return this.shooting}consumeSpecial(){let e=this.specialQueued;return this.specialQueued=!1,e}};function L(n,e){return Math.random()*(e-n)+n}var J={grunt:{hp:35,speed:80,size:l.sizes.enemySmall,scoreValue:35,bulletDamage:8,fireCooldownMs:2100,color:l.palette.enemy},runner:{hp:22,speed:120,size:l.sizes.enemySmall,scoreValue:28,bulletDamage:6,fireCooldownMs:1650,color:l.palette.enemyFast},tankette:{hp:70,speed:62,size:l.sizes.enemyMedium,scoreValue:60,bulletDamage:10,fireCooldownMs:2400,color:l.palette.enemyTank},miniBoss:{hp:230,speed:55,size:34,scoreValue:190,bulletDamage:13,fireCooldownMs:1400,color:"#ff5f9d"},boss:{hp:420,speed:45,size:l.sizes.enemyLarge,scoreValue:420,bulletDamage:16,fireCooldownMs:980,color:l.palette.enemyBoss}},we=1,N=class{constructor({x:e,y:t,type:s,bulletPattern:r}){let a=J[s]||J.grunt;this.id=we+=1,this.type=s,this.bulletPattern=r,this.x=e,this.y=t,this.hp=a.hp,this.maxHp=a.hp,this.speed=a.speed,this.size=a.size,this.scoreValue=a.scoreValue,this.bulletDamage=a.bulletDamage,this.fireCooldownMs=a.fireCooldownMs,this.color=a.color,this.lastFiredAt=0,this.dead=!1}update(e,t,s){let r=m(t.x-this.x,t.y-this.y),a=this.type==="runner"?Math.sin(s*8+this.id)*.5:0;this.x+=(r.x+a)*this.speed*e,this.y+=r.y*this.speed*e}shouldFire(e){return e-this.lastFiredAt>=this.fireCooldownMs}onFire(e){this.lastFiredAt=e}takeDamage(e){return this.hp-=e,this.hp<=0?(this.dead=!0,!0):!1}};function Se(n){let e=Math.floor(Math.random()*4),t=10;switch(e){case 0:return{x:L(t,n.width-t),y:-t};case 1:return{x:n.width+t,y:L(t,n.height-t)};case 2:return{x:L(t,n.width-t),y:n.height+t};default:return{x:-t,y:L(t,n.height-t)}}}var _=class{constructor(e){this.patterns=e.map(t=>({...t,nextSpawnAt:t.startSec}))}update(e,t){let s=[];return this.patterns.forEach(r=>{if(!(e<r.startSec||e>r.endSec)&&e>=r.nextSpawnAt){for(let a=0;a<r.count;a+=1){let i=Se(t);s.push(new N({x:i.x,y:i.y,type:r.enemyType,bulletPattern:r.bulletPattern}))}r.nextSpawnAt+=r.intervalSec}}),s}};var j=class{constructor(e){this.level=q(e),this.spawnManager=new _(this.level.spawnPatterns),this.elapsedSec=0}update(e){return this.elapsedSec+=e,this.spawnManager.update(this.elapsedSec,this.level.arenaSize)}getArenaBounds(e,t){return{width:e,height:t,padding:l.arenaPadding}}isComplete(){return this.elapsedSec>=l.runDurationSec}};var Ce=1,f=class{constructor({x:e,y:t,vx:s,vy:r,size:a=l.sizes.projectile,damage:i=1,friendly:c=!0,piercing:d=!1,explosiveRadius:u=0,lifeSec:h=2.4}){this.id=Ce+=1,this.x=e,this.y=t,this.vx=s,this.vy=r,this.size=a,this.damage=i,this.friendly=c,this.piercing=d,this.explosiveRadius=u,this.lifeSec=h,this.dead=!1}update(e){this.x+=this.vx*e,this.y+=this.vy*e,this.lifeSec-=e,this.lifeSec<=0&&(this.dead=!0)}isOutOfBounds(e,t,s=60){return this.x<-s||this.x>e+s||this.y<-s||this.y>t+s}};function Y(n,e,t){let s=m(e.x,e.y),r=Math.atan2(s.y,s.x),a=t.projectilesPerShot,i=t.spreadDegrees*Math.PI/180,c=[];for(let d=0;d<a;d+=1){let u=a===1?0:(d/(a-1)-.5)*i,h=x(r+u);c.push(new f({x:n.x,y:n.y,vx:h.x*t.projectileSpeed,vy:h.y*t.projectileSpeed,damage:t.damage,friendly:!0,piercing:t.piercing,explosiveRadius:t.explosiveRadius||0,lifeSec:t.special==="shortRange"?.6:1.8}))}return c}function V(n,e,t,s=0){let r=[];for(let a=0;a<e;a+=1){let i=x(s+a/e*Math.PI*2);r.push(new f({x:n.x,y:n.y,vx:i.x*t,vy:i.y*t,damage:n.bulletDamage,friendly:!1,size:7,lifeSec:4.3}))}return r}function Z(n,e,t,s){switch(n){case"radial":return V(e,8,180);case"spiral":{let r=s*4.2;return V(e,6,210,r)}case"aimedBurst":{let r=$(e,t);return[-.2,0,.2].map(a=>{let i=x(r+a);return new f({x:e.x,y:e.y,vx:i.x*235,vy:i.y*235,damage:e.bulletDamage+1,friendly:!1,size:6,lifeSec:3.1})})}case"wave":{let r=Math.sin(s*5)*.5;return[-.35,0,.35].map(a=>{let i=x(Math.PI/2+r+a);return new f({x:e.x,y:e.y,vx:i.x*190,vy:i.y*190,damage:e.bulletDamage,friendly:!1,size:7,lifeSec:3.8})})}case"multiPhase":{let r=$(e,t);return[-.3,0,.3].map(i=>{let c=x(r+i);return new f({x:e.x,y:e.y,vx:c.x*260,vy:c.y*260,damage:e.bulletDamage+2,friendly:!1,size:8,lifeSec:3.3})}).concat(V(e,10,170,s*1.8))}default:return[]}}function be(n,e={}){let t=Math.round(n.maxHealth*(1+(e.maxHealthPct||0))),s=n.speed*(1+(e.speedPct||0)),r=n.healthRegen+(e.healthRegenFlat||0);return{...n,maxHealth:t,speed:s,healthRegen:r,armor:S(n.armor+(e.armorFlat||0),0,.8)}}var W=class{constructor({character:e,weapon:t,upgrades:s={},startX:r,startY:a,random:i=Math.random}){this.character=e,this.weapon=t,this.upgrades=s,this.random=i,this.baseStats=be(e.baseStats,s),this.maxHealth=this.baseStats.maxHealth,this.health=this.maxHealth,this.speed=this.baseStats.speed,this.size=this.baseStats.size||l.sizes.player,this.x=r,this.y=a,this.lastShotAtMs=-99999,this.invulnerableMs=0,this.specialCooldownMs=0}getWeaponStats(){let e=this.upgrades.cooldownPct||0,t=this.upgrades.cooldownPenaltyReduction||0,r=this.weapon.cooldownMs*this.character.baseStats.cooldown*(1+e*(1-t)),a=this.upgrades.projectilesBonus||0;return{...this.weapon,cooldownMs:Math.max(65,r),projectileSpeed:this.weapon.projectileSpeed*(1+(this.upgrades.projectileSpeedPct||0)),damage:this.weapon.damage*this.character.baseStats.baseDamage,projectilesPerShot:this.weapon.projectilesPerShot+Math.round(a),piercing:this.weapon.special==="piercing"||this.random()<(this.upgrades.piercingChance||0),explosiveRadius:this.weapon.special==="explosive"?20+(this.upgrades.explosiveRadius||0):this.upgrades.explosiveRadius||0,critChance:l.defaultCritChance+(this.upgrades.critChance||0),critMultiplier:l.defaultCritMultiplier+(this.upgrades.critDamage||0)}}canShoot(e){return e-this.lastShotAtMs>=this.getWeaponStats().cooldownMs}shoot(e,t){if(!this.canShoot(t))return[];this.lastShotAtMs=t;let s=m(e.x,e.y),r=this.getWeaponStats();return this.random()<r.critChance&&(r.damage*=r.critMultiplier),this.character.id==="berserker"&&this.health/this.maxHealth<.35&&(r.damage*=1.3),Y({x:this.x,y:this.y},s,r)}move(e,t,s){let r=m(e.x,e.y);this.x+=r.x*this.speed*t,this.y+=r.y*this.speed*t;let a=this.size/2;this.x=S(this.x,a,s.width-a),this.y=S(this.y,a,s.height-a)}update(e){this.health=Math.min(this.maxHealth,this.health+this.baseStats.healthRegen*e),this.invulnerableMs=Math.max(0,this.invulnerableMs-e*1e3),this.specialCooldownMs=Math.max(0,this.specialCooldownMs-e*1e3)}applyDamage(e){if(this.invulnerableMs>0)return!1;let t=this.upgrades.shieldChance||0;if(this.random()<t)return this.invulnerableMs=180,!1;let s=e*(1-this.baseStats.armor);return this.health=Math.max(0,this.health-s),this.invulnerableMs=120,!0}heal(e){this.health=Math.min(this.maxHealth,this.health+e)}isDead(){return this.health<=0}tryUseSpecial(){return this.specialCooldownMs>0?!1:this.character.id==="ghost"?(this.invulnerableMs=1700,this.specialCooldownMs=11e3,!0):this.character.id==="engineer"?(this.specialCooldownMs=9e3,"turretBurst"):(this.specialCooldownMs=7e3,!1)}};var R=class{constructor(e){this.canvas=e,this.ctx=e.getContext("2d")}resize(e,t){let s=window.devicePixelRatio||1;this.canvas.width=Math.floor(e*s),this.canvas.height=Math.floor(t*s),this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`,this.ctx.setTransform(s,0,0,s,0,0)}clear(e){this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvas.clientWidth,this.canvas.clientHeight)}drawEntity(e,t){this.ctx.fillStyle=t,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size/2,0,Math.PI*2),this.ctx.fill()}drawBar(e,t,s,r,a,i){this.ctx.fillStyle="rgba(6, 15, 24, 0.75)",this.ctx.fillRect(e,t,s,r),this.ctx.fillStyle=i,this.ctx.fillRect(e,t,s*Math.max(0,Math.min(1,a)),r)}render(e){this.clear(e.backgroundColor),this.ctx.strokeStyle="rgba(255,255,255,0.06)",this.ctx.lineWidth=1;for(let s=24;s<this.canvas.clientHeight;s+=24)this.ctx.beginPath(),this.ctx.moveTo(0,s),this.ctx.lineTo(this.canvas.clientWidth,s),this.ctx.stroke();e.coins.forEach(s=>this.drawEntity(s,l.palette.coin)),e.projectiles.forEach(s=>this.drawEntity(s,l.palette.projectileFriendly)),e.enemyProjectiles.forEach(s=>this.drawEntity(s,l.palette.projectileEnemy)),e.enemies.forEach(s=>{this.drawEntity(s,s.color||l.palette.enemy),this.drawBar(s.x-s.size/2,s.y-s.size*.72,s.size,4,s.hp/s.maxHp,"#ff9aad")}),this.drawEntity(e.player,l.palette.player),e.player.invulnerableMs>0&&(this.ctx.strokeStyle="#8de6ff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(e.player.x,e.player.y,e.player.size*.9,0,Math.PI*2),this.ctx.stroke());let t=Math.max(0,Math.ceil(e.timeLeftSec));this.ctx.fillStyle=l.palette.text,this.ctx.font="14px Trebuchet MS",this.ctx.fillText(`Time ${t}s`,12,this.canvas.clientHeight-16)}};var Ee=[{weaponId:"smg",condition:{type:"playCount",value:2}},{weaponId:"shotgun",condition:{type:"coinsBank",value:160}},{weaponId:"sniper",condition:{type:"score",value:1200}},{weaponId:"grenade_launcher",condition:{type:"levelsCompleted",value:2}}];function Me(){return{selectedCharacterId:"rookie",selectedWeaponId:"pistol",selectedLevelId:"level1",coinsBank:0,highScore:0,levelBest:{},playCount:0,totalCoinsCollected:0,levelsCompleted:[],unlockedCharacters:["rookie"],unlockedLevels:["level1"],unlockedWeapons:["pistol"],itemLevels:{}}}function p(n){let e=Me(),t={...e,...n,levelBest:{...e.levelBest,...n?.levelBest||{}},itemLevels:{...e.itemLevels,...n?.itemLevels||{}},unlockedCharacters:Array.from(new Set([...n?.unlockedCharacters||["rookie"],"rookie"])),unlockedLevels:Array.from(new Set([...n?.unlockedLevels||["level1"],"level1"])),unlockedWeapons:Array.from(new Set([...n?.unlockedWeapons||["pistol"],"pistol"]))};return t.unlockedCharacters.includes(t.selectedCharacterId)||(t.selectedCharacterId=t.unlockedCharacters[0]),t.unlockedLevels.includes(t.selectedLevelId)||(t.selectedLevelId=t.unlockedLevels[0]),t.unlockedWeapons.includes(t.selectedWeaponId)||(t.selectedWeaponId=t.unlockedWeapons[0]),t}async function Q(n){let e=await n.get(M.profile);return p(e||{})}async function X(n,e){await n.set(M.profile,p(e))}function I(n,e){if(!e||e.type==="default")return!0;switch(e.type){case"coins":case"coinsBank":return n.coinsBank>=e.value;case"playCount":return n.playCount>=e.value;case"score":return n.highScore>=e.value;case"levelsCompleted":return n.levelsCompleted.length>=e.value;default:return!1}}function ee(n,e){let t=p(n);return t.playCount+=1,t.totalCoinsCollected+=e.coinsCollected,t.coinsBank+=e.coinsCollected,t.highScore=Math.max(t.highScore,e.score),t.levelBest[e.levelId]=Math.max(t.levelBest[e.levelId]||0,e.score),e.completed&&!t.levelsCompleted.includes(e.levelId)&&t.levelsCompleted.push(e.levelId),t}function te(n){let e=p(n),t=[];return g.forEach(s=>{!e.unlockedCharacters.includes(s.id)&&I(e,s.unlockCondition)&&(e.unlockedCharacters.push(s.id),e.unlockedWeapons.push(s.startingWeaponId),t.push(`Character unlocked: ${s.name}`))}),w.forEach(s=>{!e.unlockedLevels.includes(s.id)&&I(e,s.unlockCondition)&&(e.unlockedLevels.push(s.id),t.push(`Level unlocked: ${s.name}`))}),Ee.forEach(s=>{if(!e.unlockedWeapons.includes(s.weaponId)&&I(e,s.condition)){let r=v.find(a=>a.id===s.weaponId);e.unlockedWeapons.push(s.weaponId),t.push(`Weapon unlocked: ${r?.name||s.weaponId}`)}}),{profile:e,unlockMessages:t}}function se(n){let e=p(n);return g.map(t=>({...t,unlocked:e.unlockedCharacters.includes(t.id),canUnlock:I(e,t.unlockCondition)}))}function ne(n){let e=p(n);return w.map(t=>({...t,unlocked:e.unlockedLevels.includes(t.id),canUnlock:I(e,t.unlockCondition)}))}function oe(n){let e=p(n);return v.map(t=>({...t,unlocked:e.unlockedWeapons.includes(t.id),cost:Math.round(t.damage*9+t.projectileSpeed*.08+t.projectilesPerShot*40)}))}function ie(n,e){let t=p(n),s=g.find(a=>a.id===e);if(!s)return{ok:!1,profile:t,reason:"Character missing"};if(t.unlockedCharacters.includes(e))return t.selectedCharacterId=e,t.selectedWeaponId=s.startingWeaponId,{ok:!0,profile:t};let r=s.unlockCondition?.type==="coins"?s.unlockCondition.value:0;return r>t.coinsBank?{ok:!1,profile:t,reason:"Not enough coins"}:I(t,{...s.unlockCondition,type:s.unlockCondition.type==="coins"?"default":s.unlockCondition.type})?(t.coinsBank-=r,t.unlockedCharacters.push(e),t.unlockedWeapons.push(s.startingWeaponId),t.selectedCharacterId=e,t.selectedWeaponId=s.startingWeaponId,{ok:!0,profile:p(t)}):{ok:!1,profile:t,reason:"Requirement not met"}}function ae(n,e){let t=p(n),s=v.find(a=>a.id===e);if(!s)return{ok:!1,profile:t,reason:"Weapon missing"};if(t.unlockedWeapons.includes(e))return t.selectedWeaponId=e,{ok:!0,profile:t};let r=Math.round(s.damage*9+s.projectileSpeed*.08+s.projectilesPerShot*40);return t.coinsBank<r?{ok:!1,profile:t,reason:"Not enough coins"}:(t.coinsBank-=r,t.unlockedWeapons.push(e),t.selectedWeaponId=e,{ok:!0,profile:p(t)})}function re(n,e){let t=p(n),s=k.find(i=>i.id===e);if(!s)return{ok:!1,profile:t,reason:"Item missing"};let r=t.itemLevels[e]||0;if(r>=s.levels.length)return{ok:!1,profile:t,reason:"Max level reached"};let a=s.levels[r];return t.coinsBank<a.cost?{ok:!1,profile:t,reason:"Not enough coins"}:(t.coinsBank-=a.cost,t.itemLevels[e]=r+1,{ok:!0,profile:t})}function le(n){let e=p(n),t={};return k.forEach(s=>{let r=e.itemLevels[s.id]||0;for(let a=0;a<r;a+=1){let i=s.levels[a];Object.entries(i.statDeltas).forEach(([c,d])=>{t[c]=(t[c]||0)+d})}}),t}var A=class{constructor({characters:e,levels:t,weapons:s,sfx:r}){this.characters=e,this.levels=t,this.weapons=s,this.sfx=r,this.handlers={},this.updateToast=null,this.registration=null,this.elements={healthFill:document.getElementById("health-fill"),playerName:document.getElementById("player-name"),coins:document.getElementById("coins-display"),score:document.getElementById("score-display"),best:document.getElementById("best-display"),characterSelect:document.getElementById("character-select"),weaponSelect:document.getElementById("weapon-select"),levelSelect:document.getElementById("level-select"),overlayMenu:document.getElementById("overlay-menu"),overlayPause:document.getElementById("overlay-pause"),overlayShop:document.getElementById("overlay-shop"),overlayGameOver:document.getElementById("overlay-gameover"),gameOverSummary:document.getElementById("gameover-summary"),toastArea:document.getElementById("toast-area"),shopCoins:document.getElementById("shop-coins"),shopCharacters:document.getElementById("shop-characters"),shopWeapons:document.getElementById("shop-weapons"),shopItems:document.getElementById("shop-items")},this.bindStaticButtons(),this.setupServiceWorkerListener()}bindStaticButtons(){document.getElementById("start-button").addEventListener("click",()=>{this.handlers.startRun?.()}),document.getElementById("shop-button").addEventListener("click",()=>{this.handlers.openShop?.()}),document.getElementById("sfx-toggle").addEventListener("click",()=>{this.handlers.toggleSfx?.()}),document.getElementById("shop-close").addEventListener("click",()=>{this.handlers.closeShop?.()}),document.getElementById("pause-button").addEventListener("click",()=>{this.handlers.pause?.()}),document.getElementById("resume-button").addEventListener("click",()=>{this.handlers.resume?.()}),document.getElementById("quit-button").addEventListener("click",()=>{this.handlers.quitRun?.()}),document.getElementById("gameover-menu").addEventListener("click",()=>{this.handlers.mainMenu?.()}),this.elements.characterSelect.addEventListener("change",e=>{this.handlers.characterChanged?.(e.target.value)}),this.elements.weaponSelect.addEventListener("change",e=>{this.handlers.weaponChanged?.(e.target.value)}),this.elements.levelSelect.addEventListener("change",e=>{this.handlers.levelChanged?.(e.target.value)})}setupServiceWorkerListener(){"serviceWorker"in navigator&&(navigator.serviceWorker.addEventListener("message",e=>{e.data?.type==="SWUPDATEAVAILABLE"&&(this.sfx.play("updateAvailable"),this.showUpdateToast())}),navigator.serviceWorker.addEventListener("controllerchange",()=>{window.location.reload()}))}on(e){this.handlers=e}setServiceWorkerRegistration(e){this.registration=e}showUpdateToast(){if(this.updateToast)return;let e=document.createElement("button");e.className="toast update",e.textContent="Update available Tap to refresh.",e.addEventListener("click",()=>{let t=this.registration?.waiting;t?t.postMessage({type:"SKIP_WAITING"}):window.location.reload()}),this.updateToast=e,this.elements.toastArea.append(e)}showToast(e,t=2500){let s=document.createElement("div");s.className="toast",s.textContent=e,this.elements.toastArea.append(s),setTimeout(()=>{s.remove()},t)}updateHud({playerName:e,health:t,maxHealth:s,coins:r,score:a,best:i}){this.elements.playerName.textContent=e,this.elements.healthFill.style.width=`${Math.max(0,t/s*100)}%`,this.elements.coins.textContent=`Coins: ${r}`,this.elements.score.textContent=`Score: ${a}`,this.elements.best.textContent=`Best: ${i}`}renderMenu(e,t,s,r){this.elements.characterSelect.innerHTML="",t.forEach(a=>{let i=document.createElement("option");i.value=a.id,i.disabled=!a.unlocked,i.textContent=a.unlocked?a.name:`${a.name} (locked)`,a.id===e.selectedCharacterId&&(i.selected=!0),this.elements.characterSelect.append(i)}),this.elements.weaponSelect.innerHTML="",s.forEach(a=>{let i=document.createElement("option");i.value=a.id,i.disabled=!a.unlocked,i.textContent=a.unlocked?a.name:`${a.name} (locked)`,a.id===e.selectedWeaponId&&(i.selected=!0),this.elements.weaponSelect.append(i)}),this.elements.levelSelect.innerHTML="",r.forEach(a=>{let i=document.createElement("option");i.value=a.id,i.disabled=!a.unlocked,i.textContent=a.unlocked?a.name:`${a.name} (locked)`,a.id===e.selectedLevelId&&(i.selected=!0),this.elements.levelSelect.append(i)})}renderShop(e,t,s,r=k){this.elements.shopCoins.textContent=`Bank: ${e.coinsBank}`,this.elements.shopCharacters.innerHTML="",t.forEach(a=>{let i=document.createElement("article");i.className="shop-card";let c=a.unlockCondition?.type==="coins"?a.unlockCondition.value:0,d=e.unlockedCharacters.includes(a.id);i.innerHTML=`
        <strong>${a.name}</strong>
        <div class="shop-meta">${a.description}</div>
        <div class="shop-meta">${d?"Owned":c>0?`Cost: ${c}`:"Unlock by milestone"}</div>
      `;let u=document.createElement("button");u.textContent=d?"Select":"Unlock",u.disabled=!d&&!a.canUnlock&&c<=0,u.addEventListener("click",()=>this.handlers.buyCharacter?.(a.id)),i.append(u),this.elements.shopCharacters.append(i)}),this.elements.shopWeapons.innerHTML="",s.forEach(a=>{let i=document.createElement("article");i.className="shop-card";let c=e.unlockedWeapons.includes(a.id);i.innerHTML=`
        <strong>${a.name}</strong>
        <div class="shop-meta">Damage ${a.damage.toFixed(1)} / Cooldown ${a.cooldownMs}ms</div>
        <div class="shop-meta">${c?"Owned":`Cost: ${a.cost}`}</div>
      `;let d=document.createElement("button");d.textContent=c?"Equip":"Buy",d.disabled=!c&&e.coinsBank<a.cost,d.addEventListener("click",()=>this.handlers.buyWeapon?.(a.id)),i.append(d),this.elements.shopWeapons.append(i)}),this.elements.shopItems.innerHTML="",r.forEach(a=>{let i=e.itemLevels[a.id]||0,c=i>=a.levels.length,d=a.levels[i],u=document.createElement("article");u.className="shop-card",u.innerHTML=`
        <strong>${a.name}</strong>
        <div class="shop-meta">${a.description}</div>
        <div class="shop-meta">Level ${i}/${a.levels.length}</div>
      `;let h=document.createElement("button");h.textContent=c?"Maxed":`Upgrade (${d.cost})`,h.disabled=c||e.coinsBank<d.cost,h.addEventListener("click",()=>this.handlers.buyItem?.(a.id)),u.append(h),this.elements.shopItems.append(u)})}setOverlay(e){[this.elements.overlayMenu,this.elements.overlayPause,this.elements.overlayShop,this.elements.overlayGameOver].forEach(s=>s.classList.remove("visible")),e&&(e==="menu"&&this.elements.overlayMenu.classList.add("visible"),e==="pause"&&this.elements.overlayPause.classList.add("visible"),e==="shop"&&this.elements.overlayShop.classList.add("visible"),e==="gameover"&&this.elements.overlayGameOver.classList.add("visible"))}showGameOver(e){this.elements.gameOverSummary.innerHTML=`
      <div>Score: ${e.score}</div>
      <div>Coins earned: ${e.coins}</div>
      <div>Best on level: ${e.levelBest}</div>
      <div>${e.completed?"Level survived!":"You were overwhelmed."}</div>
    `,this.setOverlay("gameover")}};var T=class{constructor(e="survivor:"){this.prefix=e}makeKey(e){return`${this.prefix}${e}`}async get(e){let t=globalThis.localStorage.getItem(this.makeKey(e));if(t==null)return null;try{return JSON.parse(t)}catch{return null}}async set(e,t){globalThis.localStorage.setItem(this.makeKey(e),JSON.stringify(t))}async remove(e){globalThis.localStorage.removeItem(this.makeKey(e))}async clear(){(await this.keys()).forEach(t=>{globalThis.localStorage.removeItem(this.makeKey(t))})}async keys(){let e=[];for(let t=0;t<globalThis.localStorage.length;t+=1){let s=globalThis.localStorage.key(t);s&&s.startsWith(this.prefix)&&e.push(s.slice(this.prefix.length))}return e}};function ce(){return new T}function de(n){let e=n.size/2;return{left:n.x-e,right:n.x+e,top:n.y-e,bottom:n.y+e}}function ue(n,e){let t=de(n),s=de(e);return t.left<=s.right&&t.right>=s.left&&t.top<=s.bottom&&t.bottom>=s.top}function G(n,e){return ue(n,e)}function he(n,e){return ue(n,e)}var O=ce(),y=document.getElementById("game-canvas"),K=new R(y),z=new D({canvas:y,joystickZone:document.getElementById("joystick-zone"),joystickKnob:document.getElementById("joystick-knob"),shootButton:document.getElementById("shoot-button"),specialButton:document.getElementById("special-button")});z.attach();var o={profile:null,ui:null,sfx:null,run:{active:!1,paused:!1,elapsedSec:0,coinsCollected:0,score:0,levelController:null,player:null,upgrades:{},enemies:[],projectiles:[],enemyProjectiles:[],coins:[],backgroundColor:"#0f2238"}};function F(n,e){let t=n.x-e.x,s=n.y-e.y;return t*t+s*s}function Ie(){return o.profile.levelBest[o.profile.selectedLevelId]||0}function b(){let n=se(o.profile),e=ne(o.profile),t=oe(o.profile);o.ui.renderMenu(o.profile,n,t,e),o.ui.renderShop(o.profile,n,t,k)}function E(){let n=o.run.player;o.ui.updateHud({playerName:n?.character.name||H(o.profile.selectedCharacterId).name,health:n?.health||0,maxHealth:n?.maxHealth||1,coins:o.run.active?o.run.coinsCollected:o.profile.coinsBank,score:o.run.active?o.run.score:o.profile.highScore,best:Ie()})}function pe(){let n=document.getElementById("game-frame");K.resize(n.clientWidth,n.clientHeight)}function me(n){let e=[],t=Math.min(5,Math.max(1,Math.round(n.scoreValue/80)));for(let s=0;s<t;s+=1){let r=s/t*Math.PI*2;e.push({x:n.x+Math.cos(r)*9,y:n.y+Math.sin(r)*9,size:l.sizes.coin,value:1,lifeSec:l.coinLifetimeSec})}return e}function Be(){if(o.run.enemies.length>0){let n=o.run.enemies.reduce((e,t)=>e?F(t,o.run.player)<F(e,o.run.player)?t:e:t,null);return{x:n.x-o.run.player.x,y:n.y-o.run.player.y}}return{x:0,y:-1}}function Pe(n){let e=[];for(let t=0;t<10;t+=1){let s=x(t/10*Math.PI*2);e.push(new f({x:n.x,y:n.y,vx:s.x*300,vy:s.y*300,damage:9,friendly:!0,lifeSec:1.1}))}return e}function De(){let n=H(o.profile.selectedCharacterId),e=U(o.profile.selectedWeaponId||n.startingWeaponId),t=o.profile.unlockedWeapons.includes(e.id)?e:U(n.startingWeaponId),s=le(o.profile);o.run.active=!0,o.run.paused=!1,o.run.elapsedSec=0,o.run.coinsCollected=0,o.run.score=0,o.run.levelController=new j(o.profile.selectedLevelId),o.run.backgroundColor=o.run.levelController.level.backgroundColor,o.run.upgrades=s,o.run.enemies=[],o.run.projectiles=[],o.run.enemyProjectiles=[],o.run.coins=[],o.run.player=new W({character:n,weapon:t,upgrades:s,startX:y.clientWidth*.5,startY:y.clientHeight*.7}),o.ui.setOverlay(null),E()}async function C(){await X(O,o.profile)}async function fe(n){let e={score:o.run.score,coinsCollected:o.run.coinsCollected,levelId:o.profile.selectedLevelId,completed:n};o.run.active=!1,o.run.paused=!1,o.profile=ee(o.profile,e);let t=te(o.profile);o.profile=t.profile,await C(),n&&o.sfx.play("levelUp"),t.unlockMessages.forEach(s=>o.ui.showToast(s,3200)),b(),E(),o.ui.showGameOver({score:e.score,coins:e.coinsCollected,levelBest:o.profile.levelBest[e.levelId]||e.score,completed:n})}function Le(n){if(!o.run.active||o.run.paused)return;let e=performance.now();o.run.elapsedSec+=n;let t=z.getMovement(),s=o.run.levelController.getArenaBounds(y.clientWidth,y.clientHeight);if(o.run.player.move(t,n,s),o.run.player.update(n),z.consumeSpecial()&&o.run.player.tryUseSpecial()==="turretBurst"&&(o.run.projectiles.push(...Pe(o.run.player)),o.sfx.play("shoot")),z.isShooting()){let i=z.getLookDirection(Be()),c=o.run.player.shoot(i,e);c.length&&(o.run.projectiles.push(...c),o.sfx.play("shoot"))}let r=o.run.levelController.update(n);o.run.enemies.push(...r),o.run.enemies.forEach(i=>{i.update(n,o.run.player,o.run.elapsedSec),i.shouldFire(e)&&(i.onFire(e),o.run.enemyProjectiles.push(...Z(i.bulletPattern,i,o.run.player,o.run.elapsedSec)))}),o.run.projectiles.forEach(i=>i.update(n)),o.run.enemyProjectiles.forEach(i=>i.update(n)),o.run.projectiles.forEach(i=>{if(!i.dead)for(let c=0;c<o.run.enemies.length;c+=1){let d=o.run.enemies[c];if(d.dead||!G(i,d))continue;let u=d.takeDamage(i.damage);if(i.explosiveRadius>0&&o.run.enemies.forEach(h=>{let ye=F(h,d);if(!h.dead&&ye<=i.explosiveRadius*i.explosiveRadius){let ge=i.damage*.55;h.takeDamage(ge)&&(o.run.score+=h.scoreValue,o.run.coins.push(...me(h)),o.sfx.play("enemyDeath"))}}),u&&(o.run.score+=d.scoreValue,o.run.coins.push(...me(d)),o.sfx.play("enemyDeath")),i.piercing||(i.dead=!0),!i.piercing)break}}),o.run.enemyProjectiles.forEach(i=>{if(!i.dead&&G(i,o.run.player)){let c=o.run.player.applyDamage(i.damage);i.dead=!0,c&&o.sfx.play("hit")}}),o.run.enemies.forEach(i=>{!i.dead&&he(o.run.player,i)&&o.run.player.applyDamage(10)&&o.sfx.play("hit")});let a=l.coinBasePickupRadius+(o.run.upgrades.coinMagnetFlat||0);if(o.run.coins.forEach(i=>{if(i.lifeSec-=n,i.lifeSec<=0){i.dead=!0;return}F(i,o.run.player)<=a*a&&(i.dead=!0,o.run.coinsCollected+=i.value,o.sfx.play("coin"))}),o.run.projectiles=o.run.projectiles.filter(i=>!i.dead&&!i.isOutOfBounds(y.clientWidth,y.clientHeight)),o.run.enemyProjectiles=o.run.enemyProjectiles.filter(i=>!i.dead&&!i.isOutOfBounds(y.clientWidth,y.clientHeight)),o.run.enemies=o.run.enemies.filter(i=>!i.dead),o.run.coins=o.run.coins.filter(i=>!i.dead),E(),o.run.player.isDead()){fe(!1);return}o.run.levelController.isComplete()&&fe(!0)}function je(){if(!o.run.player){K.clear("#0f2238");return}K.render({player:o.run.player,enemies:o.run.enemies,projectiles:o.run.projectiles,enemyProjectiles:o.run.enemyProjectiles,coins:o.run.coins,backgroundColor:o.run.backgroundColor,timeLeftSec:l.runDurationSec-o.run.elapsedSec})}function We(){o.ui.on({startRun:()=>De(),openShop:()=>{b(),o.ui.setOverlay("shop")},closeShop:()=>{o.ui.setOverlay("menu")},pause:()=>{o.run.active&&(o.run.paused=!0,o.ui.setOverlay("pause"))},resume:()=>{o.run.paused=!1,o.ui.setOverlay(null)},quitRun:()=>{o.run.active=!1,o.run.paused=!1,o.ui.setOverlay("menu"),E()},mainMenu:()=>{o.ui.setOverlay("menu"),E()},characterChanged:n=>{if(o.profile.unlockedCharacters.includes(n)){o.profile.selectedCharacterId=n;let e=H(n);o.profile.unlockedWeapons.includes(e.startingWeaponId)&&(o.profile.selectedWeaponId=e.startingWeaponId),C(),b()}},weaponChanged:n=>{o.profile.unlockedWeapons.includes(n)&&(o.profile.selectedWeaponId=n,C())},levelChanged:n=>{o.profile.unlockedLevels.includes(n)&&(o.profile.selectedLevelId=n,C(),E())},buyCharacter:n=>{let e=ie(o.profile,n);o.profile=e.profile,e.ok?(o.sfx.play("shopBuy"),C()):o.ui.showToast(e.reason||"Unable to buy character"),b()},buyWeapon:n=>{let e=ae(o.profile,n);o.profile=e.profile,e.ok?(o.sfx.play("shopBuy"),C()):o.ui.showToast(e.reason||"Unable to buy weapon"),b()},buyItem:n=>{let e=re(o.profile,n);o.profile=e.profile,e.ok?(o.sfx.play("shopBuy"),C()):o.ui.showToast(e.reason||"Unable to buy upgrade"),b()},toggleSfx:async()=>{let n=!o.sfx.enabled;o.sfx.setEnabled(n),await O.set(M.sfxEnabled,n),o.ui.showToast(`SFX ${n?"on":"off"}`)}})}async function Re(){if(!("serviceWorker"in navigator)){o.ui.showToast("Service worker not supported in this browser.",2e3);return}try{let n=await navigator.serviceWorker.register("./service-worker.js");o.ui.setServiceWorkerRegistration(n),n.waiting&&o.ui.showUpdateToast(),n.addEventListener("updatefound",()=>{let e=n.installing;e&&e.addEventListener("statechange",()=>{e.state==="installed"&&navigator.serviceWorker.controller&&o.ui.showUpdateToast()})})}catch(n){console.warn("Service worker registration failed",n)}}async function Ae(){pe(),window.addEventListener("resize",pe);let n=await O.get(M.sfxEnabled)??!0;o.sfx=new B(!!n),o.profile=await Q(O),o.ui=new A({characters:g,levels:w,weapons:v,sfx:o.sfx}),We(),b(),E(),o.ui.setOverlay("menu"),await Re(),new P({update:Le,render:je}).start()}Ae();})();
